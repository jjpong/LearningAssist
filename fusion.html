<!DOCTYPE html>
<html lang="zh-TW" class="no-js">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>恆星核融合 2048 (Fusion 2048)</title>
    <!-- 引入 Tone.js 音效庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 的 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 自訂樣式和動畫 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }

        #game-board-container {
            touch-action: none; /* 將 touch-action: none 僅應用於遊戲棋盤 */
        }

        .tile {
            transform: translate(var(--x, 0), var(--y, 0));
        }

        /* 遊戲方塊的生成動畫 */
        @keyframes spawn {
            from {
                transform: translate(var(--x, 0), var(--y, 0)) scale(0);
                opacity: 0;
            }
            to {
                transform: translate(var(--x, 0), var(--y, 0)) scale(1);
                opacity: 1;
            }
        }
        .tile-spawned {
            animation: spawn 0.2s ease-out;
        }

        /* 遊戲方塊合併時的彈出動畫 */
        @keyframes merge-pop {
            0% { transform: translate(var(--x, 0), var(--y, 0)) scale(1); }
            50% { transform: translate(var(--x, 0), var(--y, 0)) scale(1.2); }
            100% { transform: translate(var(--x, 0), var(--y, 0)) scale(1); }
        }
        .tile-merged {
            animation: merge-pop 0.2s ease-in-out;
        }

        /* 不穩定同位素的脈動動畫 */
        @keyframes pulse {
            0% { box-shadow: 0 0 8px 4px rgba(255, 82, 82, 0.7); }
            50% { box-shadow: 0 0 12px 6px rgba(255, 82, 82, 1); }
            100% { box-shadow: 0 0 8px 4px rgba(255, 82, 82, 0.7); }
        }
        .unstable-pulse {
            animation: pulse 1.5s infinite;
        }

        /* 高能質子的脈動動畫 */
        @keyframes high-energy-pulse {
            0% { box-shadow: 0 0 8px 4px rgba(253, 224, 71, 0.7); }
            50% { box-shadow: 0 0 12px 6px rgba(253, 224, 71, 1); }
            100% { box-shadow: 0 0 8px 4px rgba(253, 224, 71, 0.7); }
        }
        .high-energy-pulse {
            animation: high-energy-pulse 1.5s infinite;
        }
        
        /* 隱藏滾動條 */
        #synthesis-log::-webkit-scrollbar {
            width: 8px;
        }
        #synthesis-log::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #synthesis-log::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #synthesis-log::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #synthesis-log {
            -ms-overflow-style: auto;  /* IE and Edge */
            scrollbar-width: thin;  /* Firefox */
        }
        
        /* 上下標垂直對齊樣式 */
        .iso-stack {
            display: inline-flex;
            flex-direction: column;
            text-align: center;
            vertical-align: middle;
            margin-right: 0.1em;
            line-height: 1;
        }
        .iso-stack sup, .iso-stack sub {
            font-size: 0.5em; /* 調整上下標字體大小 */
            line-height: 1.1;
        }
        #periodic-table {
            grid-template-columns: repeat(18, minmax(0, 1fr));
        }

        /* 勝利動畫樣式 */
        @keyframes glow-and-fade {
            0% { opacity: 0; transform: scale(0.8); box-shadow: 0 0 0px 0px rgba(255, 255, 150, 0); }
            50% { opacity: 1; transform: scale(1); box-shadow: 0 0 40px 20px rgba(255, 255, 150, 0.7); }
            100% { opacity: 0; transform: scale(1.2); box-shadow: 0 0 0px 0px rgba(255, 255, 150, 0); }
        }
        .win-animation-card {
            opacity: 0;
            animation: glow-and-fade 3s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div id="main-container" class="w-full max-w-5xl mx-auto transition-opacity duration-500">
        <header class="text-center mb-4">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-700">FUSION 2048</h1>
            <p class="text-gray-500 mt-1 text-sm sm:text-base">恆星元素鍊金術</p>
        </header>

        <div class="flex justify-center items-center mb-4 space-x-2 sm:space-x-4">
            <div class="bg-gray-200 p-2 sm:p-3 rounded-lg text-center">
                <div class="text-xs sm:text-sm text-gray-500">分數</div>
                <div id="score" class="text-xl sm:text-2xl font-bold">0</div>
            </div>
            <button id="new-game-button" class="px-4 py-2 sm:px-6 sm:py-3 bg-orange-500 text-white font-bold rounded-lg shadow-md hover:bg-orange-600 transition-colors text-sm sm:text-base">
                新遊戲
            </button>
            <div class="bg-gray-200 p-2 sm:p-3 rounded-lg text-center">
                <div class="text-xs sm:text-sm text-gray-500">回合</div>
                <div id="turn-counter" class="text-xl sm:text-2xl font-bold">0</div>
            </div>
            <button id="open-instruction-button" class="p-2 sm:p-3 bg-gray-200 rounded-lg shadow-md hover:bg-gray-300 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </button>
            <button id="sound-toggle-button" class="p-2 sm:p-3 bg-gray-200 rounded-lg shadow-md hover:bg-gray-300 transition-colors">
                <svg id="sound-on-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                <svg id="sound-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
            </button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- 遊戲主區域 -->
            <main class="w-full flex-shrink-0 min-w-0">
                <div id="game-board-container" class="relative w-full aspect-square bg-gray-400 rounded-lg p-2.5 grid grid-cols-4 grid-rows-4 gap-2.5">
                    <!-- JS 動態生成背景格子和遊戲方塊 -->
                </div>
            </main>

            <!-- 側邊欄 -->
            <aside class="w-full flex flex-col gap-4 min-w-0">
                <div class="flex-shrink-0">
                    <!-- 元素週期表 -->
                    <div class="bg-white p-2 sm:p-4 rounded-lg shadow">
                        <h2 class="text-base sm:text-lg font-bold text-center mb-2">元素發現紀錄 (點擊查詢)</h2>
                        <div id="periodic-table" class="grid gap-0.5 text-xs cursor-pointer">
                            <!-- JS 動態生成元素週期表 -->
                        </div>
                    </div>
                     <!-- 合成提示 -->
                    <div id="hint-container" class="bg-white p-3 sm:p-4 rounded-lg shadow mt-4">
                        <h2 class="text-base sm:text-lg font-bold text-center mb-2">下一步提示</h2>
                        <div id="hint-content" class="text-center text-gray-600 text-sm md:text-base">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                </div>
                <!-- 合成日誌 -->
                <div class="bg-white p-2 sm:p-4 rounded-lg shadow flex flex-col flex-grow min-h-0">
                    <h2 class="text-base sm:text-lg font-bold text-center mb-2 flex-shrink-0">合成日誌</h2>
                    <ul id="synthesis-log" class="overflow-y-auto text-sm space-y-1 pr-2 flex-grow">
                        <li class="text-gray-500">遊戲開始...</li>
                    </ul>
                </div>
            </aside>
        </div>
        <footer class="text-center text-gray-400 text-xs mt-4">
            <p>&copy; 2025 由小p老師設計 Gemini 協作</p>
        </footer>
    </div>

    <!-- 勝利動畫容器 -->
    <div id="win-animation-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40 hidden">
        <div id="win-animation-card" class="w-48 h-48 sm:w-64 sm:h-64 p-2 flex items-center justify-center text-5xl sm:text-7xl font-bold rounded-lg transition-all duration-500">
            <!-- JS will populate this -->
        </div>
    </div>


    <!-- 遊戲說明視窗 -->
    <div id="instruction-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto relative">
            <button id="close-instruction-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div class="text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-4">歡迎來到核融合 2048！</h2>
            </div>
            <div class="text-gray-600 space-y-4 text-sm sm:text-base">
                <p>這不只是一款遊戲，更是一趟探索恆星核心秘密的旅程。您的目標是模擬恆星內部，從最基本的質子和中子開始，一步步融合出更重的元素。</p>
                <div class="p-4 bg-gray-100 rounded-lg">
                    <h3 class="font-bold text-lg mb-2 text-gray-800">勝利目標</h3>
                    <p>最終的勝利目標，是合成出恆星核融合的終點——<strong>鐵 (<span class="iso-stack"><sup>56</sup><sub>26</sub></span>Fe)</strong>！</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-2 text-gray-800">遊戲玩法</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>使用<strong>方向鍵</strong>或<strong>滑動螢幕</strong>來移動所有粒子。</li>
                        <li>相同的粒子碰撞會融合成更重的粒子。</li>
                        <li><strong>注意！</strong>某些反應會產生<strong>不穩定同位素</strong> (帶有紅色光暈和倒數計時)，必須在時間內用中子穩定，否則會衰變！</li>
                    </ul>
                </div>
                 <div>
                    <h3 class="font-bold text-lg mb-2 text-gray-800">特殊規則</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>高能質子 (P⁺)</strong>: 合成氧(O)或更重的元素後，即有機會產生。它是所有進階質子反應的唯一鑰匙！但它會在2回合後降級為普通質子。</li>
                        <li><strong>3α反應</strong>: 合成碳是關鍵！您需要將三個氦-4 (<sup>4</sup><sub>2</sub>He) 排列在一起（直線或L型）才能觸發。</li>
                        <li><strong>稀有元素</strong>: 鋰(Li)、鈹(Be)、硼(B) 等元素無法透過主要融合鏈產生，需要使用高能質子來觸發特殊反應才能得到。</li>
                         <li><strong>提示</strong>: 點擊右側週期表上的元素符號可以查詢詳細的合成方式。</li>
                    </ul>
                </div>
                 <p class="text-center font-bold pt-4">祝您在星辰的鍊金術中玩得愉快！</p>
            </div>
        </div>
    </div>


    <!-- 遊戲結束/勝利/提示彈出視窗 -->
    <div id="game-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 text-center max-w-sm w-full">
            <h2 id="modal-title" class="text-2xl sm:text-3xl font-bold mb-4">遊戲標題</h2>
            <div id="modal-content" class="mb-6 text-gray-600 text-left">
                <!-- 動態內容 -->
            </div>
            <button id="modal-restart-button" class="w-full px-6 py-3 bg-orange-500 text-white font-bold rounded-lg shadow-md hover:bg-orange-600 transition-colors">
                重新開始
            </button>
             <button id="modal-close-button" class="w-full mt-2 px-6 py-3 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition-colors">
                關閉
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素獲取 ---
            const mainContainer = document.getElementById('main-container');
            const gameBoardContainer = document.getElementById('game-board-container');
            const scoreElement = document.getElementById('score');
            const turnCounterElement = document.getElementById('turn-counter');
            const newGameButton = document.getElementById('new-game-button');
            const periodicTable = document.getElementById('periodic-table');
            const synthesisLog = document.getElementById('synthesis-log');
            const hintContent = document.getElementById('hint-content');
            const gameModal = document.getElementById('game-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalRestartButton = document.getElementById('modal-restart-button');
            const modalCloseButton = document.getElementById('modal-close-button');
            const soundToggleButton = document.getElementById('sound-toggle-button');
            const soundOnIcon = document.getElementById('sound-on-icon');
            const soundOffIcon = document.getElementById('sound-off-icon');
            const instructionModal = document.getElementById('instruction-modal');
            const closeInstructionButton = document.getElementById('close-instruction-button');
            const openInstructionButton = document.getElementById('open-instruction-button');
            const winAnimationContainer = document.getElementById('win-animation-container');
            const winAnimationCard = document.getElementById('win-animation-card');

            // --- 音效管理器 ---
            const audioManager = {
                isInitialized: false,
                isMuted: false,
                synths: {},
                bgmLoop: null,

                async init() {
                    if (this.isInitialized) return;
                    await Tone.start();
                    this.synths.move = new Tone.Synth({ oscillator: { type: 'sine' }, volume: -12, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                    this.synths.merge = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, volume: -6, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
                    this.synths.decay = new Tone.NoiseSynth({ noise: { type: 'pink' }, volume: -14, envelope: { attack: 0.01, decay: 0.15, sustain: 0, release: 0.1 } }).toDestination();
                    this.synths.specialMerge = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'fatsawtooth' }, volume: -4, envelope: { attack: 0.05, decay: 0.5, sustain: 0.1, release: 0.5 } }).toDestination();
                    this.synths.discovery = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sine' }, volume: -4, envelope: { attack: 0.05, decay: 0.8, sustain: 0.2, release: 0.8 } }).toDestination();
                    this.synths.win = new Tone.Synth({ oscillator: { type: 'sine' }, volume: -2, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.5 } }).toDestination();
                    this.synths.lose = new Tone.Synth({ oscillator: { type: 'fmsquare' }, volume: -9, envelope: { attack: 0.05, decay: 0.5, sustain: 0, release: 0.5 } }).toDestination();
                    this.synths.winSequence = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle8' }, volume: -6 }).toDestination();
                    this.synths.bgm = new Tone.Synth({
                        oscillator: { type: "fatsine", spread: 40, count: 3 },
                        envelope: { attack: 2, decay: 1, sustain: 0.8, release: 5 }
                    }).toDestination();
                    this.synths.bgm.volume.value = -22;
                    
                    const bgmNotes = ["C3", "G3", "D4", "A3", "E4", "B3"];
                    let noteIndex = 0;
                    this.bgmLoop = new Tone.Loop(time => {
                        this.synths.bgm.triggerAttackRelease(bgmNotes[noteIndex % bgmNotes.length], "1m", time);
                        noteIndex++;
                    }, '1m').start(0);


                    this.isInitialized = true;
                    console.log('Audio initialized.');
                    this.toggleBgm(true);
                },

                play(sound, ...args) {
                    if (!this.isInitialized || this.isMuted) return;
                    if (this.synths[sound]) {
                        const now = Tone.now();
                        if (sound === 'decay') {
                            const offset = args[0] || 0;
                            this.synths.decay.triggerAttackRelease("8n", now + offset);
                        }
                        else if (sound === 'win') this.synths.win.triggerAttackRelease('C5', '8n', now);
                        else if (sound === 'lose') this.synths.lose.triggerAttackRelease('C3', '4n', now);
                        else this.synths[sound].triggerAttackRelease(...args, now);
                    }
                },
                
                toggleMute() {
                    this.isMuted = !this.isMuted;
                    soundOnIcon.classList.toggle('hidden', this.isMuted);
                    soundOffIcon.classList.toggle('hidden', !this.isMuted);
                    this.toggleBgm(!this.isMuted);
                },

                toggleBgm(shouldPlay) {
                    if (!this.isInitialized) return;
                    if (shouldPlay && !this.isMuted) {
                        Tone.Transport.start();
                    } else {
                        Tone.Transport.stop();
                    }
                }
            };
            

            // --- 遊戲設定 ---
            const GRID_SIZE = 4;
            const PERIODIC_TABLE_DATA = {
                'H': { row: 1, col: 1 }, 'He': { row: 1, col: 18 },
                'Li': { row: 2, col: 1 }, 'Be': { row: 2, col: 2 },
                'B': { row: 2, col: 13 }, 'C': { row: 2, col: 14 }, 'N': { row: 2, col: 15 }, 'O': { row: 2, col: 16 }, 'Ne': { row: 2, col: 18 },
                'Mg': { row: 3, col: 2 }, 'Al': { row: 3, col: 13 }, 'Si': { row: 3, col: 14 }, 'P': { row: 3, col: 15 }, 'S': { row: 3, col: 16 }, 'Cl': { row: 3, col: 17 }, 'Ar': { row: 3, col: 18 },
                'Ca': { row: 4, col: 2 }, 'Ti': { row: 4, col: 4 }, 'Cr': { row: 4, col: 6 }, 'Fe': { row: 4, col: 8 },
            };

            // --- 元素資料庫 ---
            const ELEMENT_DATA = {
                'p':    { name: '質子', mass: 1, displayName: '<span class="iso-stack"><sup>1</sup><sub>1</sub></span>P', color: 'bg-red-200', textColor: 'text-red-800' },
                'n':    { name: '中子', mass: 1, displayName: '<span class="iso-stack"><sup>1</sup><sub>0</sub></span>n', color: 'bg-gray-300', textColor: 'text-gray-800' },
                'p_high': { name: '高能質子', mass: 1, displayName: '<span class="iso-stack"><sup>1</sup><sub>1</sub></span>P<sup>+</sup>', color: 'bg-yellow-300', textColor: 'text-yellow-900', isHighEnergy: true, unstable: true, countdown: 2 },
                'H-1':  { name: '氫',   symbol: 'H', mass: 1, displayName: '<span class="iso-stack"><sup>1</sup><sub>1</sub></span>H',  isElement: true, color: 'bg-red-300', textColor: 'text-red-900' },
                'H-2':  { name: '氘',   symbol: 'H', mass: 2, displayName: '<span class="iso-stack"><sup>2</sup><sub>1</sub></span>D',  isElement: true, color: 'bg-purple-300', textColor: 'text-purple-900' },
                'H-3':  { name: '氚',   symbol: 'H', mass: 3, displayName: '<span class="iso-stack"><sup>3</sup><sub>1</sub></span>T',  isElement: true, color: 'bg-indigo-300', textColor: 'text-indigo-900' },
                'Li-6': { name: '鋰',   symbol: 'Li', mass: 6, displayName: '<span class="iso-stack"><sup>6</sup><sub>3</sub></span>Li',  isElement: true, color: 'bg-pink-300', textColor: 'text-pink-900' },
                'He-2': { name: '氦-2', symbol: 'He', mass: 2, displayName: '<span class="iso-stack"><sup>2</sup><sub>2</sub></span>He', isElement: true, unstable: true, countdown: 2, color: 'bg-purple-200', textColor: 'text-purple-800' },
                'He-3': { name: '氦-3', symbol: 'He', mass: 3, displayName: '<span class="iso-stack"><sup>3</sup><sub>2</sub></span>He', isElement: true, color: 'bg-green-300', textColor: 'text-green-900' },
                'He-4': { name: '氦',   symbol: 'He', mass: 4, displayName: '<span class="iso-stack"><sup>4</sup><sub>2</sub></span>He', isElement: true, color: 'bg-green-400', textColor: 'text-green-900' },
                'Be-8': { name: '鈹-8', symbol: 'Be', mass: 8, displayName: '<span class="iso-stack"><sup>8</sup><sub>4</sub></span>Be', unstable: true, countdown: 0, color: 'bg-yellow-200', textColor: 'text-yellow-800' },
                'Be-9': { name: '鈹',   symbol: 'Be', mass: 9, displayName: '<span class="iso-stack"><sup>9</sup><sub>4</sub></span>Be', isElement: true, color: 'bg-yellow-400', textColor: 'text-yellow-900' },
                'B-11': { name: '硼',   symbol: 'B', mass: 11, displayName: '<span class="iso-stack"><sup>11</sup><sub>5</sub></span>B', isElement: true, color: 'bg-teal-300', textColor: 'text-teal-900' },
                'C-12': { name: '碳',   symbol: 'C', mass: 12, displayName: '<span class="iso-stack"><sup>12</sup><sub>6</sub></span>C', isElement: true, color: 'bg-gray-500', textColor: 'text-white' },
                'N-13': { name: '氮-13', symbol: 'N', mass: 13, displayName: '<span class="iso-stack"><sup>13</sup><sub>7</sub></span>N', isElement: true, unstable: true, countdown: 4, color: 'bg-sky-200', textColor: 'text-sky-800' },
                'O-16': { name: '氧',   symbol: 'O', mass: 16, displayName: '<span class="iso-stack"><sup>16</sup><sub>8</sub></span>O', isElement: true, color: 'bg-blue-400', textColor: 'text-blue-900' },
                'Ne-20':{ name: '氖',   symbol: 'Ne', mass: 20, displayName: '<span class="iso-stack"><sup>20</sup><sub>10</sub></span>Ne',isElement: true, color: 'bg-indigo-400', textColor: 'text-indigo-900' },
                'Mg-24':{ name: '鎂',   symbol: 'Mg', mass: 24, displayName: '<span class="iso-stack"><sup>24</sup><sub>12</sub></span>Mg',isElement: true, color: 'bg-pink-400', textColor: 'text-pink-900' },
                'Al-27':{ name: '鋁',   symbol: 'Al', mass: 27, displayName: '<span class="iso-stack"><sup>27</sup><sub>13</sub></span>Al',isElement: true, color: 'bg-gray-400', textColor: 'text-gray-800' },
                'Si-28':{ name: '矽',   symbol: 'Si', mass: 28, displayName: '<span class="iso-stack"><sup>28</sup><sub>14</sub></span>Si',isElement: true, color: 'bg-yellow-400', textColor: 'text-yellow-900' },
                'P-31': { name: '磷',   symbol: 'P', mass: 31, displayName: '<span class="iso-stack"><sup>31</sup><sub>15</sub></span>P', isElement: true, color: 'bg-red-400', textColor: 'text-red-900' },
                'S-32': { name: '硫',   symbol: 'S', mass: 32, displayName: '<span class="iso-stack"><sup>32</sup><sub>16</sub></span>S', isElement: true, color: 'bg-yellow-500', textColor: 'text-yellow-900' },
                'Cl-35':{ name: '氯',   symbol: 'Cl', mass: 35, displayName: '<span class="iso-stack"><sup>35</sup><sub>17</sub></span>Cl',isElement: true, color: 'bg-green-500', textColor: 'text-white' },
                'Ar-36':{ name: '氬',   symbol: 'Ar', mass: 36, displayName: '<span class="iso-stack"><sup>36</sup><sub>18</sub></span>Ar',isElement: true, color: 'bg-cyan-400', textColor: 'text-cyan-900' },
                'Ca-40':{ name: '鈣',   symbol: 'Ca', mass: 40, displayName: '<span class="iso-stack"><sup>40</sup><sub>20</sub></span>Ca',isElement: true, color: 'bg-lime-400', textColor: 'text-lime-900' },
                'Ti-44':{ name: '鈦-44',symbol: 'Ti', mass: 44, displayName: '<span class="iso-stack"><sup>44</sup><sub>22</sub></span>Ti',isElement: true, unstable: true, countdown: 6, color: 'bg-gray-400', textColor: 'text-gray-900' },
                'Cr-48':{ name: '鉻-48',symbol: 'Cr', mass: 48, displayName: '<span class="iso-stack"><sup>48</sup><sub>24</sub></span>Cr',isElement: true, unstable: true, countdown: 5, color: 'bg-blue-gray-400', textColor: 'text-blue-gray-900' },
                'Fe-52':{ name: '鐵-52',symbol: 'Fe', mass: 52, displayName: '<span class="iso-stack"><sup>52</sup><sub>26</sub></span>Fe',isElement: true, unstable: true, countdown: 4, color: 'bg-orange-400', textColor: 'text-orange-900' },
                'Fe-56':{ name: '鐵',   symbol: 'Fe', mass: 56, displayName: '<span class="iso-stack"><sup>56</sup><sub>26</sub></span>Fe',isElement: true, isWin: true, color: 'bg-orange-600', textColor: 'text-white' },
                'Ni-56': { name: '鎳-56', symbol: 'Ni', mass: 56, displayName: '<span class="iso-stack"><sup>56</sup><sub>28</sub></span>Ni', color: 'bg-green-600', textColor: 'text-white'},
                'Co-56': { name: '鈷-56', symbol: 'Co', mass: 56, displayName: '<span class="iso-stack"><sup>56</sup><sub>27</sub></span>Co', color: 'bg-blue-600', textColor: 'text-white'},
            };
            
            const SYNTHESIS_HINTS = {
                'H': '氫是所有核融合的起點。<br>• <strong><sup>1</sup><sub>1</sub>P + <sup>1</sup><sub>1</sub>P &rarr; <sup>2</sup><sub>2</sub>He</strong><br>• <strong><sup>1</sup><sub>1</sub>P + <sup>1</sup><sub>0</sub>n &rarr; <sup>2</sup><sub>1</sub>D</strong>',
                'He': '氦是恆星能量的主要來源。<br>• <strong><sup>2</sup><sub>2</sub>He + <sup>1</sup><sub>0</sub>n &rarr; <sup>3</sup><sub>2</sub>He</strong> (穩定化)<br>• <strong><sup>3</sup><sub>2</sub>He + <sup>3</sup><sub>2</sub>He &rarr; <sup>4</sup><sub>2</sub>He</strong><br>• <strong><sup>3</sup><sub>1</sub>T + <sup>1</sup><sub>1</sub>P &rarr; <sup>4</sup><sub>2</sub>He</strong>',
                'Li': '鋰主要來自宇宙射線散裂，或在特定條件下的核融合。<br>• <strong><sup>2</sup><sub>1</sub>D + <sup>4</sup><sub>2</sub>He &rarr; <sup>6</sup><sub>3</sub>Li</strong><br>• <span class="text-red-600">注意: 鋰會被質子摧毀！<br>  <strong><sup>1</sup><sub>1</sub>P⁺ + <sup>6</sup><sub>3</sub>Li &rarr; <sup>4</sup><sub>2</sub>He</strong></span>',
                'Be': '鈹主要來自宇宙射線散裂。<br>• <strong><sup>1</sup><sub>1</sub>P⁺ + <sup>12</sup><sub>6</sub>C &rarr; <sup>9</sup><sub>4</sub>Be</strong><br>• <span class="text-red-600">注意: 鈹會被質子摧毀！<br>  <strong><sup>1</sup><sub>1</sub>P⁺ + <sup>9</sup><sub>4</sub>Be &rarr; <sup>6</sup><sub>3</sub>Li</strong></span>',
                'B': '硼主要來自宇宙射線散裂。<br>• <strong><sup>1</sup><sub>1</sub>P⁺ + <sup>16</sup><sub>8</sub>O &rarr; <sup>11</sup><sub>5</sub>B</strong><br>• <span class="text-red-600">注意: 硼會被質子摧毀！<br>  <strong><sup>1</sup><sub>1</sub>P⁺ + <sup>11</sup><sub>5</sub>B &rarr; <sup>8</sup><sub>4</sub>Be</strong> (衰變)</span>',
                'C': '碳的誕生是關鍵！讓三個 <strong><sup>4</sup><sub>2</sub>He</strong> 在同一直線上或 L 型相鄰觸發「3α反應」。',
                'O': '透過α捕獲來合成氧。<br>• <strong><sup>12</sup><sub>6</sub>C + <sup>4</sup><sub>2</sub>He &rarr; <sup>16</sup><sub>8</sub>O</strong>',
                'N': '氮是CNO催化循環的關鍵。<br>• <strong><sup>12</sup><sub>6</sub>C + <sup>1</sup><sub>1</sub>P⁺ &rarr; <sup>13</sup><sub>7</sub>N</strong> (啟動循環)<br>• <span class="text-blue-600">氮-13衰變時會變回碳並獎勵一個氦-4！</span>',
                'Ne': '繼續α捕獲！<br>• <strong><sup>16</sup><sub>8</sub>O + <sup>4</sup><sub>2</sub>He &rarr; <sup>20</sup><sub>10</sub>Ne</strong>',
                'Al': '鋁是質子捕獲的產物。<br>• <strong><sup>24</sup><sub>12</sub>Mg + <sup>1</sup><sub>1</sub>P⁺ &rarr; <sup>27</sup><sub>13</sub>Al</strong>',
                'Si': '繼續α捕獲！<br>• <strong><sup>24</sup><sub>12</sub>Mg + <sup>4</sup><sub>2</sub>He &rarr; <sup>28</sup><sub>14</sub>Si</strong>',
                'P': '磷是質子捕獲的產物。<br>• <strong><sup>28</sup><sub>14</sub>Si + <sup>1</sup><sub>1</sub>P⁺ &rarr; <sup>31</sup><sub>15</sub>P</strong>',
                'S': '繼續α捕獲！<br>• <strong><sup>28</sup><sub>14</sub>Si + <sup>4</sup><sub>2</sub>He &rarr; <sup>32</sup><sub>16</sub>S</strong>',
                'Cl': '氯是質子捕獲的產物。<br>• <strong><sup>32</sup><sub>16</sub>S + <sup>1</sup><sub>1</sub>P⁺ &rarr; <sup>35</sup><sub>17</sub>Cl</strong>',
                'default': '繼續用 <strong><sup>4</sup><sub>2</sub>He</strong> 進行α捕獲，或嘗試重元素之間的融合！'
            };


            // --- 遊戲狀態 ---
            let grid;
            let score;
            let turn;
            let discoveredElements;
            let unlockedIsotopes;
            let isMoving = false;
            let tileIdCounter;
            let specialSpawnQueue = null;
            let highEnergyProtonUnlocked = false;

            // --- 初始化遊戲 ---
            function setupGame() {
                grid = Array.from({ length: GRID_SIZE }, () => Array(GRID_SIZE).fill(null));
                score = 0;
                turn = 0;
                tileIdCounter = 0;
                discoveredElements = new Set(['H']);
                unlockedIsotopes = new Set(['p', 'n']);
                isMoving = false;
                specialSpawnQueue = null;
                highEnergyProtonUnlocked = false;
                
                updateScore(0);
                updateTurn(0);
                setupBoardHTML();
                setupPeriodicTable();
                updateHints();
                clearLog();
                addLog('遊戲開始！請用方向鍵或滑動操作。');

                spawnParticle();
                spawnParticle();
                renderBoard();

                instructionModal.classList.remove('hidden');
            }
            
            function setupBoardHTML() {
                gameBoardContainer.innerHTML = '';
                for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'w-full h-full bg-gray-300 rounded';
                    gameBoardContainer.appendChild(cell);
                }
            }
            
            function setupPeriodicTable() {
                periodicTable.innerHTML = '';
                 for (let i = 0; i < 4 * 18; i++) {
                    const cell = document.createElement('div');
                    periodicTable.appendChild(cell);
                }

                for (const el in PERIODIC_TABLE_DATA) {
                    if (Object.hasOwnProperty.call(PERIODIC_TABLE_DATA, el)) {
                        const { row, col } = PERIODIC_TABLE_DATA[el];
                        const index = (row - 1) * 18 + (col - 1);
                        if (index < periodicTable.children.length) {
                            const cell = periodicTable.children[index];
                            
                            const baseClasses = 'border rounded text-center font-bold transition-colors text-[10px] sm:text-xs leading-tight aspect-square flex items-center justify-center';
                            cell.className = baseClasses;
                            
                            const stateClasses = discoveredElements.has(el) ? 'bg-green-200 text-green-800 hover:bg-green-300' : 'bg-gray-200 text-gray-400 hover:bg-gray-300';
                            cell.classList.add(...stateClasses.split(' '));
                            cell.textContent = el;
                            cell.dataset.element = el;
                        }
                    }
                }
            }

            function updatePeriodicTable() {
                 for (const el in PERIODIC_TABLE_DATA) {
                    const cell = periodicTable.querySelector(`[data-element="${el}"]`);
                    if (cell && discoveredElements.has(el) && !cell.classList.contains('bg-green-200')) {
                        const oldClasses = 'bg-gray-200 text-gray-400 hover:bg-gray-300'.split(' ');
                        const newClasses = 'bg-green-200 text-green-800 hover:bg-green-300'.split(' ');
                        cell.classList.remove(...oldClasses);
                        cell.classList.add(...newClasses);
                    }
                }
            }

            // --- 渲染與更新 ---
            function renderBoard() {
                const existingTiles = new Set(Array.from(document.querySelectorAll('.tile')).map(t => t.dataset.id));

                for (let r = 0; r < GRID_SIZE; r++) {
                    for (let c = 0; c < GRID_SIZE; c++) {
                        const cell = grid[r][c];
                        if (cell) {
                            let tile = document.querySelector(`[data-id="${cell.id}"]`);
                            const data = ELEMENT_DATA[cell.type] || {};

                            if (tile) { // Update existing tile
                                tile.style.setProperty('--x', `${c * 100}%`);
                                tile.style.setProperty('--y', `${r * 100}%`);
                                
                                let needsStyleUpdate = tile.dataset.type !== cell.type;

                                if (needsStyleUpdate) {
                                    tile.className = `tile absolute w-1/4 h-1/4 p-1 flex items-center justify-center text-base md:text-xl font-bold rounded-md transition-transform duration-100 ease-in-out leading-none ${data.color} ${data.textColor}`;
                                    tile.innerHTML = data.displayName || '?';
                                    tile.dataset.type = cell.type;
                                    tile.classList.add('tile-merged');
                                    tile.addEventListener('animationend', () => tile.classList.remove('tile-merged'), { once: true });
                                }
                                
                                if(cell.isHighEnergy) {
                                    tile.classList.add('high-energy-pulse');
                                } else {
                                    tile.classList.remove('high-energy-pulse');
                                }

                                if(cell.unstable) {
                                    tile.classList.add('unstable-pulse');
                                    if(!tile.querySelector('.countdown')) {
                                        const countdownEl = document.createElement('span');
                                        countdownEl.className = 'countdown absolute top-0 right-1 text-xs font-black';
                                        tile.appendChild(countdownEl);
                                    }
                                    tile.querySelector('.countdown').textContent = cell.countdown;
                                } else {
                                     tile.classList.remove('unstable-pulse');
                                     const countdownEl = tile.querySelector('.countdown');
                                     if(countdownEl) countdownEl.remove();
                                }
                                existingTiles.delete(String(cell.id));
                            } else { // Create new tile
                                tile = document.createElement('div');
                                tile.style.setProperty('--x', `${c * 100}%`);
                                tile.style.setProperty('--y', `${r * 100}%`);
                                tile.className = `tile absolute w-1/4 h-1/4 p-1 flex items-center justify-center text-base md:text-xl font-bold rounded-md leading-none ${data.color} ${data.textColor} tile-spawned`;
                                if (cell.isHighEnergy) tile.classList.add('high-energy-pulse');
                                tile.innerHTML = data.displayName || '?';
                                tile.dataset.id = cell.id;
                                tile.dataset.type = cell.type;
                                tile.addEventListener('animationend', () => tile.classList.remove('tile-spawned'), { once: true });
                                gameBoardContainer.appendChild(tile);
                            }
                        }
                    }
                }

                existingTiles.forEach(id => {
                    const tile = document.querySelector(`[data-id="${id}"]`);
                    if (tile) tile.remove();
                });
            }

            function updateScore(points) {
                score += points;
                scoreElement.textContent = score;
            }
            
            function updateTurn(newTurn) {
                turn = newTurn;
                turnCounterElement.textContent = turn;
            }

            function addLog(message, isDiscovery = false) {
                const li = document.createElement('li');
                if (isDiscovery) {
                    li.className = 'text-blue-600 font-bold';
                }
                li.innerHTML = `<span class="font-bold text-gray-400">[${turn}]</span> ${message}`;
                if (synthesisLog.firstChild) {
                    synthesisLog.insertBefore(li, synthesisLog.firstChild);
                } else {
                    synthesisLog.appendChild(li);
                }
            }

            function clearLog() {
                synthesisLog.innerHTML = '';
            }

            const HINT_CHAIN = [
                { required: ['p'], text: `試著合併 <strong><sup>1</sup><sub>1</sub>P + <sup>1</sup><sub>1</sub>P</strong> &rarr; 不穩定的 <sup>2</sup><sub>2</sub>He！` },
                { required: ['He-2'], text: `快用 <strong><sup>1</sup><sub>0</sub>n</strong> 穩定 <sup>2</sup><sub>2</sub>He &rarr; <sup>3</sup><sub>2</sub>He！` },
                { required: ['H-2'], text: `試著合成氚: <sup>2</sup><sub>1</sub>D + <strong><sup>1</sup><sub>0</sub>n</strong> &rarr; <sup>3</sup><sub>1</sub>T` },
                { required: ['He-3'], text: `合成氦-4: <br><sup>3</sup><sub>2</sub>He + <sup>3</sup><sub>2</sub>He &rarr; <sup>4</sup><sub>2</sub>He` },
                { required: ['He-4'], text: `關鍵一步！將三個 <strong><sup>4</sup><sub>2</sub>He</strong> 排在一起合成 <strong><sup>12</sup><sub>6</sub>C</strong>！` },
                { required: ['C-12'], text: `<strong>α捕獲</strong>: <sup>12</sup><sub>6</sub>C + <strong><sup>4</sup><sub>2</sub>He</strong> &rarr; <sup>16</sup><sub>8</sub>O` },
                { required: ['O-16'], text: `繼續用 <strong><sup>4</sup><sub>2</sub>He</strong> 進行α捕獲！` },
                { required: ['Fe-56'], text: `恭喜！您已到達恆星核融合的終點！` },
            ];
            
            function updateHints() {
                let currentHint = "祝您玩得愉快！";
                for (const hint of HINT_CHAIN) {
                    const hasAllRequired = hint.required.every(iso => unlockedIsotopes.has(iso));
                    if (hasAllRequired) {
                        currentHint = hint.text;
                    } else {
                        break;
                    }
                }
                hintContent.innerHTML = currentHint;
            }
            
            // --- 遊戲邏輯 ---
 function spawnParticle(forceType = null) {
    const emptyCells = [];
    for (let r = 0; r < GRID_SIZE; r++) {
        for (let c = 0; c < GRID_SIZE; c++) {
            if (grid[r][c] === null) {
                emptyCells.push({ r, c });
            }
        }
    }

    if (emptyCells.length > 0) {
        const { r, c } = emptyCells[Math.floor(Math.random() * emptyCells.length)];
        let type = forceType;

        // --- 以下是關鍵修正 ---
        if (!type) {
            // 1. 先決定基礎粒子是質子還是中子
            if (Math.random() < 0.7) { // 70% 機率是質子類
                // 2. 如果是質子，再檢查是否要升級為高能質子
                if (highEnergyProtonUnlocked && Math.random() < 0.25) { // 如果已解鎖，則有 50% 機率升級
                    type = 'p_high';
                    // 為了讓玩家知道，可以加個日誌
                    addLog('一個<strong>高能質子</strong>隨機出現在熔爐中！');
                } else {
                    type = 'p'; // 否則就是普通質子
                }
            } else { // 30% 機率是中子
                type = 'n';
            }
        }
        // --- 修正結束 ---

        grid[r][c] = {
            id: tileIdCounter++,
            type: type,
            ...ELEMENT_DATA[type]
        };
    }
}

            
            function handleInput(e) {
                if (isMoving || !instructionModal.classList.contains('hidden')) return;
                    if (e.key === 'w') { // 按下 'w' 鍵來觸發勝利動畫
        startWinAnimation();
        return;
    }
                let moved = false;
                switch (e.key) {
                    case 'ArrowUp':    moved = move('up'); break;
                    case 'ArrowDown':  moved = move('down'); break;
                    case 'ArrowLeft':  moved = move('left'); break;
                    case 'ArrowRight': moved = move('right'); break;
                    default: return;
                }

                if (moved) {
                    isMoving = true;
                    setTimeout(() => {
                        handleTurnEnd();
                    }, 150); // Animation duration
                }
            }
            
            function handleTurnEnd() {
                updateTurn(turn + 1);
                
                renderBoard(); 
                
                const tripleAlphaHappened = checkForTripleAlpha();
                if (tripleAlphaHappened) {
                    renderBoard();
                }

                processDecay();

                if (specialSpawnQueue) {
                    spawnParticle(specialSpawnQueue);
                    specialSpawnQueue = null;
                } else {
                    spawnParticle();
                }
                
                clearMergeLocks();
                renderBoard();
                updatePeriodicTable();
                updateHints();
                
                isMoving = false;
                const gameState = checkGameState();
                if (gameState === 'win') {
                    startWinAnimation();
                    return;
                }
                
                if (gameState === 'lose') {
                    audioManager.play('lose');
                    showLoseModal();
                }
            }
            
            function clearMergeLocks() {
                for (let r = 0; r < GRID_SIZE; r++) {
                    for (let c = 0; c < GRID_SIZE; c++) {
                        if (grid[r][c]) {
                            grid[r][c].mergedThisTurn = false;
                        }
                    }
                }
            }

            function move(direction) {
                const traversals = buildTraversals(direction);
                let moved = false;

                traversals.x.forEach(x => {
                    traversals.y.forEach(y => {
                        const currentPos = { r: (direction === 'up' || direction === 'down') ? y : x, c: (direction === 'up' || direction === 'down') ? x : y };
                        const cell = grid[currentPos.r][currentPos.c];

                        if (cell) {
                            const { farthest, next } = findFarthestPosition(currentPos, direction);

                            if (next && next.cell && !cell.mergedThisTurn && !next.cell.mergedThisTurn && canMerge(cell, next.cell)) {
                                const mergeResult = merge(cell, next.cell);
                                
                                if (mergeResult) {
                                    grid[next.r][next.c] = {
                                        ...mergeResult,
                                        id: next.cell.id,
                                        mergedThisTurn: true
                                    };
                                    grid[currentPos.r][currentPos.c] = null;
                                    moved = true;
                                }
                            
                            } else if (farthest.r !== currentPos.r || farthest.c !== currentPos.c) {
                                grid[farthest.r][farthest.c] = cell;
                                grid[currentPos.r][currentPos.c] = null;
                                moved = true;
                            }
                        }
                    });
                });
                
                if (moved) {
                    audioManager.play('move', 'C5', '16n');
                    renderBoard();
                }
                return moved;
            }

            function buildTraversals(direction) {
                const traversals = { x: [], y: [] };
                for (let i = 0; i < GRID_SIZE; i++) {
                    traversals.x.push(i);
                    traversals.y.push(i);
                }
                if (direction === 'right') traversals.x.reverse();
                if (direction === 'down') traversals.y.reverse();
                return traversals;
            }
            
            function findFarthestPosition(pos, direction) {
                let current = { ...pos };
                let farthest = { ...pos };
                let nextPos;

                const vector = getVector(direction);

                do {
                    farthest = { ...current };
                    current.r += vector.r;
                    current.c += vector.c;
                } while (isInBounds(current) && grid[current.r][current.c] === null);
                
                if (isInBounds(current)) {
                   nextPos = { r: current.r, c: current.c, cell: grid[current.r][current.c] };
                }

                return { farthest, next: nextPos };
            }

            function getVector(direction) {
                switch (direction) {
                    case 'up': return { r: -1, c: 0 };
                    case 'down': return { r: 1, c: 0 };
                    case 'left': return { r: 0, c: -1 };
                    case 'right': return { r: 0, c: 1 };
                }
            }

            function isInBounds(pos) {
                return pos.r >= 0 && pos.r < GRID_SIZE && pos.c >= 0 && pos.c < GRID_SIZE;
            }

            function canMerge(a, b) {
                if (!a || !b) return false;
                const key = [a.type, b.type].sort().join('+');
                return !!FUSION_RULES[key];
            }
            
            const createFusionRules = (rules) => {
                const sortedRules = {};
                for (const key in rules) {
                    const parts = key.split('+');
                    const sortedKey = parts.sort().join('+');
                    sortedRules[sortedKey] = rules[key];
                }
                return sortedRules;
            }

            const FUSION_RULES_UNSORTED = {
                'p+p': { result: 'He-2', score: 2, note: ' (極不穩定)' },
                'p+n': { result: 'H-2', score: 2 }, 
                'H-2+n': { result: 'H-3', score: 5 },
                'H-2+H-3': { result: 'He-4', score: 50, note: '(D-T 融合!)' },
                'H-2+He-4': { result: 'Li-6', score: 30 },
                'H-2+p': { result: 'He-3', score: 5 },
                'H-3+p': { result: 'He-4', score: 25 },
                'He-2+n': { result: 'He-3', score: 10, note: '(穩定化)' },
                'He-3+He-3': { result: 'He-4', score: 20, note: '(釋放2質子)' },
                'He-3+n': { result: 'He-4', score: 15 },
                'He-4+He-4': { result: 'Be-8', score: -5, note: ' &rarr; 瞬間衰變!' },
                // 質子捕獲 (製造奇數)
                'p_high+Mg-24': { result: 'Al-27', score: 300 },
                'p_high+Si-28': { result: 'P-31', score: 350 },
                'p_high+S-32': { result: 'Cl-35', score: 400 },
                'p_high+Al-27': { result: 'Si-28', score: -20, note: '(質子燃燒)'},
                'p_high+P-31': { result: 'S-32', score: -20, note: '(質子燃燒)'},
                'p_high+Cl-35': { result: 'Ar-36', score: -20, note: '(質子燃燒)'},
                // 高能質子破碎 (製造稀有)
                'p_high+C-12': { result: 'N-13', score: 220, note: ' (CNO循環啟動!)'},
                'p_high+O-16': { result: 'B-11', score: 250, note: ' (宇宙射線散裂)'},
                'p_high+Li-6': { result: 'He-4', score: -10, note: ' (質子燃燒)' },
                'p_high+Be-9': { result: 'Li-6', score: -10, note: ' (質子燃燒)' },
                'p_high+B-11': { result: 'Be-8', score: -10, note: ' (質子燃燒)' },
                 // 主要融合鏈
                'C-12+He-4': { result: 'O-16', score: 100 }, 
                'O-16+He-4': { result: 'Ne-20', score: 150 },
                'Ne-20+He-4': { result: 'Mg-24', score: 200 }, 
                'Mg-24+He-4': { result: 'Si-28', score: 250 }, 
                'Si-28+He-4': { result: 'S-32', score: 300 },
                'S-32+He-4': { result: 'Ar-36', score: 350 }, 
                'Ar-36+He-4': { result: 'Ca-40', score: 400 }, 
                'Ca-40+He-4': { result: 'Ti-44', score: 450 },
                'Ti-44+He-4': { result: 'Cr-48', score: 500 }, 
                'Cr-48+He-4': { result: 'Fe-52', score: 550 }, 
                'Fe-52+He-4': { result: 'Fe-56', score: 1000, isWin: true },
                'C-12+C-12': { result: 'Mg-24', score: 400 }, 
                'O-16+O-16': { result: 'Si-28', score: 500 },
            };
            
            const FUSION_RULES = createFusionRules(FUSION_RULES_UNSORTED);

            function merge(a, b) {
                const key = [a.type, b.type].sort().join('+');
                const rule = FUSION_RULES[key];
                
                if (!rule) return null;

                const resultType = rule.result;
                const resultData = ELEMENT_DATA[resultType];
                
                if (!resultData) {
                    console.error("Missing element data for type:", resultType);
                    return null;
                }

                const isFirstDiscovery = !unlockedIsotopes.has(resultType);
                
                if (isFirstDiscovery) {
                    audioManager.play('discovery', ['C5', 'E5', 'G5'], '4n');
                } else {
                    audioManager.play('merge', ['C4', 'E4', 'G4'], '8n');
                }
                
                updateScore(rule.score);
                
                let logMsg = `${ELEMENT_DATA[a.type].displayName} + ${ELEMENT_DATA[b.type].displayName} &rarr; <strong>${resultData.displayName}</strong>`;
                if(rule.note) logMsg += rule.note;
                addLog(logMsg, isFirstDiscovery);

                unlockedIsotopes.add(resultType);
                if (resultData.isElement) {
                    discoveredElements.add(resultData.symbol);
                }

                // Chance to spawn high energy proton
                if (resultData.mass >= 16) {
                    if (!highEnergyProtonUnlocked) {
                        highEnergyProtonUnlocked = true;
                        addLog('<strong>熔爐溫度提升！</strong>現在有機會產生高能質子了！', true);
                    }
                    if (isFirstDiscovery) {
                        specialSpawnQueue = 'p_high';
                        addLog('<strong>重大發現！</strong>一個高能質子被激發了！', true);
                    } 
                }

                return { type: resultType, ...resultData };
            }

            function checkForTripleAlpha() {
                let merged = false;
                const processTriple = (c1, c2, c3, cornerIndex) => {
                    const cells = [c1, c2, c3];
                    const cornerCell = cells[cornerIndex];
                    cells.splice(cornerIndex, 1);
                    
                    grid[cells[0].r][cells[0].c] = null;
                    grid[cells[1].r][cells[1].c] = null;

                    const resultData = ELEMENT_DATA['C-12'];
                    const isFirst = !unlockedIsotopes.has('C-12');
                    
                    grid[cornerCell.r][cornerCell.c] = { id: cornerCell.id, type: 'C-12', ...resultData, mergedThisTurn: true };
                    
                    addLog(`<strong>3α反應!</strong> 3x ${ELEMENT_DATA['He-4'].displayName} &rarr; <strong>${ELEMENT_DATA['C-12'].displayName}</strong>`, isFirst);
                    updateScore(150);
                    
                    if (isFirst) {
                        audioManager.play('discovery', ['C5', 'E5', 'G5', 'C6'], '2n');
                    } else {
                        audioManager.play('specialMerge', ['C4', 'E4', 'G4', 'C5'], '2n');
                    }
                    
                    unlockedIsotopes.add('C-12');
                    if (!discoveredElements.has('C')) discoveredElements.add('C');
                    return true;
                };

                for (let i = 0; i < GRID_SIZE; i++) {
                    for (let j = 0; j < GRID_SIZE - 2; j++) {
                        const h_cells = [grid[i][j], grid[i][j+1], grid[i][j+2]].map((cell, idx) => ({...cell, r: i, c: j+idx}));
                        if (h_cells.every(c => c.type === 'He-4')) {
                            return processTriple(h_cells[0], h_cells[1], h_cells[2], 1);
                        }
                        const v_cells = [grid[j][i], grid[j+1][i], grid[j+2][i]].map((cell, idx) => ({...cell, r: j+idx, c: i}));
                        if (v_cells.every(c => c.type === 'He-4')) {
                             return processTriple(v_cells[0], v_cells[1], v_cells[2], 1);
                        }
                    }
                }
                
                for (let r = 0; r < GRID_SIZE - 1; r++) {
                    for (let c = 0; c < GRID_SIZE - 1; c++) {
                        const square = [
                            {...grid[r][c], r, c}, {...grid[r][c+1], r, c: c+1},
                            {...grid[r+1][c], r: r+1, c}, {...grid[r+1][c+1], r: r+1, c: c+1}
                        ];
                        const he4_cells = square.filter(cell => cell.type === 'He-4');

                        if (he4_cells.length === 3) {
                            const [c1, c2, c3] = he4_cells;
                            if ((c1.r === c2.r && c1.c === c3.c) || (c1.c === c2.c && c1.r === c3.r)) return processTriple(c1,c2,c3,0);
                            if ((c2.r === c1.r && c2.c === c3.c) || (c2.c === c1.c && c2.r === c3.r)) return processTriple(c1,c2,c3,1);
                            if ((c3.r === c1.r && c3.c === c2.c) || (c3.c === c1.c && c3.r === c2.r)) return processTriple(c1,c2,c3,2);
                        }
                    }
                }

                return merged;
            }
            
            function processDecay() {
                let decayOffset = 0;
                for (let r = 0; r < GRID_SIZE; r++) {
                    for (let c = 0; c < GRID_SIZE; c++) {
                        const cell = grid[r][c];
                        if (cell && cell.unstable) {
                            cell.countdown--;
                            if (cell.countdown <= 0) {
                                audioManager.play('decay', decayOffset);
                                decayOffset += 0.05;
                                if (cell.type === 'p_high') {
                                    addLog(`<strong class="text-yellow-500">${ELEMENT_DATA[cell.type].displayName}</strong> 能量耗盡，變回 <strong>普通質子</strong>！`);
                                    const newData = ELEMENT_DATA['p'];
                                    grid[r][c] = { id: cell.id, type: 'p', ...newData };
                                } else if (cell.type === 'He-2') {
                                    addLog(`<strong class="text-red-500">${ELEMENT_DATA[cell.type].displayName}</strong> 衰變回 <strong>質子</strong>！`);
                                    const newData = ELEMENT_DATA['p'];
                                    grid[r][c] = { id: cell.id, type: 'p', ...newData };
                                } else if (cell.type === 'Be-8') {
                                    addLog(`<strong class="text-red-500">${ELEMENT_DATA[cell.type].displayName}</strong> 瞬間衰變了！`);
                                    grid[r][c] = null;
                                } else if (cell.type === 'N-13') {
                                    addLog(`<strong>CNO循環</strong>: <strong class="text-blue-500">${ELEMENT_DATA[cell.type].displayName}</strong> 衰變回 <strong>${ELEMENT_DATA['C-12'].displayName}</strong> 並釋放 <strong>${ELEMENT_DATA['He-4'].displayName}</strong>！`);
                                    const newData = ELEMENT_DATA['C-12'];
                                    grid[r][c] = { id: cell.id, type: 'C-12', ...newData };
                                    spawnParticleInEmptyNeighbor(r, c, 'He-4');
                                } else {
                                    addLog(`<strong class="text-red-500">${ELEMENT_DATA[cell.type].displayName}</strong> 衰變了！`);
                                    grid[r][c] = null;
                                    updateScore(-50); // Decay penalty
                                }
                            }
                        }
                    }
                }
            }

             function spawnParticleInEmptyNeighbor(r, c, type) {
                const neighbors = [ {r: r-1, c}, {r: r+1, c}, {r: r, c: c-1}, {r: r, c: c+1} ];
                const emptyNeighbors = neighbors.filter(pos => isInBounds(pos) && grid[pos.r][pos.c] === null);
                if (emptyNeighbors.length > 0) {
                    const pos = emptyNeighbors[Math.floor(Math.random() * emptyNeighbors.length)];
                    grid[pos.r][pos.c] = { id: tileIdCounter++, type: type, ...ELEMENT_DATA[type] };
                } else {
                    spawnParticle();
                }
             }
            
            function checkGameState() {
                if (grid.flat().some(cell => cell?.isWin)) return 'win';
                if (grid.flat().some(cell => cell === null)) return 'playing';

                for (let r = 0; r < GRID_SIZE; r++) {
                    for (let c = 0; c < GRID_SIZE; c++) {
                        const cell = grid[r][c];
                        if (!cell) continue;
                        if (r < GRID_SIZE - 1 && canMerge(cell, grid[r+1][c])) return 'playing';
                        if (c < GRID_SIZE - 1 && canMerge(cell, grid[r][c+1])) return 'playing';
                    }
                }
                
                return 'lose';
            }

            function showWinModal() {
                modalTitle.textContent = '超新星爆發！';
                modalContent.innerHTML = `
                    <p>恭喜！您成功在恆星熔爐中煉成了宇宙中最穩定的元素——<strong>鐵-56</strong>！</p>
                    <p class="mt-2">這顆恆星的生命走到了輝煌的終點，並在超新星爆炸中播撒了無數重元素。</p>
                    <p class="mt-4 font-bold text-lg">最終分數: ${score}</p>
                `;
                modalRestartButton.classList.remove('hidden');
                modalCloseButton.classList.add('hidden');
                gameModal.classList.remove('hidden');
            }

            function showLoseModal() {
                modalTitle.textContent = '恆星熄滅';
                modalContent.innerHTML = `
                    <p>棋盤已經鎖死，沒有更多可以進行的核融合反應。</p>
                    <p class="mt-2">這顆恆星的核心已經冷卻，無法再發光發熱。</p>
                    <p class="mt-4 font-bold text-lg">最終分數: ${score}</p>
                `;
                modalRestartButton.classList.remove('hidden');
                modalCloseButton.classList.add('hidden');
                gameModal.classList.remove('hidden');
            }

             function showHintModal(elementSymbol) {
                const hint = SYNTHESIS_HINTS[elementSymbol] || SYNTHESIS_HINTS['default'];
                modalTitle.textContent = `如何合成 ${elementSymbol} ?`;
                modalContent.innerHTML = hint;
                modalRestartButton.classList.add('hidden');
                modalCloseButton.classList.remove('hidden');
                gameModal.classList.remove('hidden');
            }
            
             function startWinAnimation() {
    // 1. 隱藏主遊戲畫面，顯示動畫專用的容器
    mainContainer.classList.add('opacity-0');
    winAnimationContainer.classList.remove('hidden');
    
    // 2. 定義動畫的每一個步驟
    const sequence = [
        { delay: 0, type: 'Ni-56', sound: ['C4', 'G4', 'C5'], duration: '1n' },
        { delay: 3500, type: 'Co-56', sound: ['D4', 'A4', 'D5'], duration: '1n' },
        { delay: 7000, type: 'Fe-56', sound: ['E4', 'B4', 'E5', 'G#5'], duration: '0.5n' }
    ];
    
    // 3. 遍歷序列，依序執行每一個動畫步驟
    sequence.forEach(step => {
        setTimeout(() => {
            const data = ELEMENT_DATA[step.type];
            
            // --- 以下是關鍵修正 ---

            // 步驟 A: 先移除動畫 class，讓元素恢復初始狀態 (opacity: 0)
            winAnimationCard.classList.remove('win-animation-card');

            // 步驟 B: 更新卡片的基礎樣式 (顏色) 和內容。
            // 注意：這裡不再使用 winAnimationCard.className = `...` 來避免覆蓋所有 class。
            // 我們先設定一個乾淨的基礎 class 列表。
            winAnimationCard.className = `w-48 h-48 sm:w-64 sm:h-64 p-2 flex items-center justify-center text-5xl sm:text-7xl font-bold rounded-lg ${data.color} ${data.textColor}`;
            winAnimationCard.innerHTML = data.displayName;

            // 步驟 C: 強制瀏覽器重新計算樣式 (reflow)。這是重啟動畫的關鍵技巧。
            void winAnimationCard.offsetWidth; 

            // 步驟 D: 重新加上動畫 class，觸發動畫從頭播放。
            winAnimationCard.classList.add('win-animation-card');
            
            // 播放對應的音效
            audioManager.play('winSequence', step.sound, step.duration);
        }, step.delay);
    });

    // 4. 在所有動畫步驟結束後，顯示最終的勝利視窗
    setTimeout(() => {
        winAnimationContainer.classList.add('hidden');
        mainContainer.classList.remove('opacity-0');
        showWinModal();
    }, 10500); // 總時長
}
            
            // --- 事件監聽 ---
            window.addEventListener('keydown', handleInput);
            
            newGameButton.addEventListener('click', () => {
                audioManager.init();
                gameModal.classList.add('hidden');
                setupGame();
            });

            closeInstructionButton.addEventListener('click', () => {
                audioManager.init();
                instructionModal.classList.add('hidden');
            });

            openInstructionButton.addEventListener('click', () => {
                instructionModal.classList.remove('hidden');
            });

            modalRestartButton.addEventListener('click', () => {
                gameModal.classList.add('hidden');
                setupGame();
            });
            modalCloseButton.addEventListener('click', () => {
                gameModal.classList.add('hidden');
            });
            periodicTable.addEventListener('click', (e) => {
                audioManager.init();
                const target = e.target.closest('[data-element]');
                if (target) {
                    const symbol = target.dataset.element;
                    showHintModal(symbol);
                }
            });
            soundToggleButton.addEventListener('click', () => {
                audioManager.init();
                audioManager.toggleMute();
            });
            
            // --- 觸控滑動支援 ---
            let touchStartX = 0, touchStartY = 0;
            gameBoardContainer.addEventListener('touchstart', e => {
                audioManager.init();
                if (!instructionModal.classList.contains('hidden')) return;
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, {passive: true});

            gameBoardContainer.addEventListener('touchend', e => {
                if (!instructionModal.classList.contains('hidden')) return;
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
            });
            
            function handleSwipe(startX, startY, endX, endY) {
                 if (isMoving) return;
                const dx = endX - startX;
                const dy = endY - startY;
                const absDx = Math.abs(dx);
                const absDy = Math.abs(dy);

                if (Math.max(absDx, absDy) > 30) {
                    let moved = false;
                    if (absDx > absDy) {
                        moved = dx > 0 ? move('right') : move('left');
                    } else {
                        moved = dy > 0 ? move('down') : move('up');
                    }
                    if (moved) {
                        isMoving = true;
                        setTimeout(() => handleTurnEnd(), 150);
                    }
                }
            }

            // --- 啟動遊戲 ---
            setupGame();
        });
    </script>

</body>
</html>
