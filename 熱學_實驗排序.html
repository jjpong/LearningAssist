<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…ƒç´ ç‰¹æ€§é…å° - æ•¸ä½äº’å‹•ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            user-select: none;
            overscroll-behavior: none;
            /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰é‡æ•´å¹²æ“¾ */
        }
        
        /* --- éŸ¿æ‡‰å¼å¡ç‰‡åŸºç¤æ¨£å¼ --- */
        /* æ‰‹æ©Ÿé è¨­ (å°å°ºå¯¸) -> å¹³æ¿ (ä¸­å°ºå¯¸) -> æ¡Œæ©Ÿ (å¤§å°ºå¯¸) */
        .draggable-card {
            cursor: grab;
            transition: all 0.2s;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            /* é è¨­å¯¬åº¦ (Mobile): w-20 (5rem/80px) */
        }
        .draggable-card:active {
            cursor: grabbing;
            transform: scale(1.05);
            z-index: 50;
        }
        .draggable-card.dragging {
            opacity: 0.5;
        }
        
        .card-name { border-left: 4px solid #2563eb; }
        .card-symbol { border-left: 4px solid #059669; }
        .card-prop { border-left: 4px solid #e11d48; }

        /* --- Drop Zone çš„éŸ¿æ‡‰å¼ Grid ä½ˆå±€ --- */
        .drop-zone {
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s;
            min-height: 140px; /* Mobile height */
            display: grid;
            
            /* Mobile Grid: å·¦æ¬„ 5.5rem */
            grid-template-columns: 5.5rem 1fr; 
            grid-template-rows: 1fr 1fr;
            grid-template-areas:
                "symbol prop"
                "name prop";
            gap: 0.25rem;
        }
        
        /* Tablet & Desktop Grid èª¿æ•´ */
        @media (min-width: 768px) {
            .drop-zone {
                min-height: 150px;
                grid-template-columns: 6rem 1fr;
                gap: 0.5rem;
            }
        }
        @media (min-width: 1024px) {
            .drop-zone {
                min-height: 160px;
                grid-template-columns: 7rem 1fr;
            }
        }

        .drop-zone.drag-over {
            background-color: #e0f2fe;
            border-style: dashed;
            transform: scale(1.02);
        }

        /* --- å¡ç‰‡è‡ªå‹•å®šä½èˆ‡å¡«å…… --- */
        .pos-symbol { grid-area: symbol; }
        .pos-name { grid-area: name; }
        .pos-prop { grid-area: prop; }

        /* ç•¶å¡ç‰‡åœ¨æ ¼å­å…§æ™‚ï¼Œå¼·åˆ¶å¡«æ»¿ä¸¦é‡ç½®æ¨£å¼ */
        .drop-zone .draggable-card {
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            border-radius: 0.375rem; /* rounded-md */
        }
        .drop-zone .draggable-card[data-type="prop"] {
            align-items: flex-start;
            text-align: left;
            padding: 0.5rem;
            overflow-y: auto; 
        }

        /* ç¬¬äºŒéšæ®µï¼šæ•´åˆå¾Œçš„å…ƒç´ å¡Šæ¨£å¼ */
        .element-block {
            cursor: grab;
            transition: transform 0.2s;
            margin-bottom: 0.5rem;
            width: 100%; /* åœ¨å®¹å™¨å…§è‡ªé©æ‡‰ */
            max-width: 12rem; /* Mobile max width */
        }
        @media (min-width: 1024px) {
            .element-block { max-width: 14rem; }
        }

        .element-block:active {
            cursor: grabbing;
            transform: scale(1.02) rotate(2deg);
        }
        .element-block .draggable-card {
            cursor: inherit;
            pointer-events: none;
            width: 100% !important; 
            height: auto !important;
            min-height: 2rem;
        }
        
        /* åˆ†é¡ç±ƒæ¨£å¼ */
        .class-bin {
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .class-bin.drag-over {
            background-color: #f0fdf4;
            border-color: #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .custom-scroll::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- å¼·åˆ¶é–‹å§‹é¸æ“‡ç•«é¢ -->
    <div id="start-screen" class="fixed inset-0 bg-slate-900/95 z-[100] flex flex-col items-center justify-center text-white fade-in p-4">
        <div class="text-center mb-6 md:mb-10">
            <h1 class="text-3xl md:text-5xl font-bold mb-4 tracking-wider">ğŸ§ª å…ƒç´ é…å°å¤§æŒ‘æˆ°</h1>
            <p class="text-base md:text-xl text-slate-300">è«‹é¸æ“‡ä¸€ç¨®æŒ‘æˆ°æ¨¡å¼é–‹å§‹éŠæˆ²</p>
        </div>
        
        <div class="flex flex-col md:flex-row gap-4 md:gap-8 w-full max-w-2xl justify-center">
            <button onclick="startGame('name')" class="group relative flex-1 p-6 md:p-8 bg-blue-600 hover:bg-blue-500 rounded-3xl transition-all hover:-translate-y-2 hover:shadow-2xl border-b-8 border-blue-800 active:border-b-0 active:translate-y-1 flex flex-row md:flex-col items-center justify-center gap-4">
                <span class="text-4xl md:text-7xl md:mb-6 group-hover:scale-110 transition-transform">ğŸ“</span>
                <div class="text-left md:text-center">
                    <h3 class="text-xl md:text-2xl font-bold mb-1">å¡«å…¥åç¨±</h3>
                    <p class="text-xs md:text-sm text-blue-100">å ´ä¸Šå…ˆå¡«å¥½ã€Œåç¨±å¡ã€<br>ä½ éœ€è¦é…å°ç¬¦è™Ÿèˆ‡æ€§è³ª</p>
                </div>
            </button>

            <button onclick="startGame('symbol')" class="group relative flex-1 p-6 md:p-8 bg-emerald-600 hover:bg-emerald-500 rounded-3xl transition-all hover:-translate-y-2 hover:shadow-2xl border-b-8 border-emerald-800 active:border-b-0 active:translate-y-1 flex flex-row md:flex-col items-center justify-center gap-4">
                <span class="text-4xl md:text-7xl md:mb-6 group-hover:scale-110 transition-transform">ğŸ” </span>
                <div class="text-left md:text-center">
                    <h3 class="text-xl md:text-2xl font-bold mb-1">å¡«å…¥ç¬¦è™Ÿ</h3>
                    <p class="text-xs md:text-sm text-emerald-100">å ´ä¸Šå…ˆå¡«å¥½ã€Œç¬¦è™Ÿå¡ã€<br>ä½ éœ€è¦é…å°åç¨±èˆ‡æ€§è³ª</p>
                </div>
            </button>
        </div>
    </div>

    <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
    <header class="bg-white shadow-md p-2 md:p-4 z-10 shrink-0">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-2">
            <div class="flex items-center justify-center w-full md:w-auto">
                <div class="text-center md:text-left">
                    <h1 class="text-lg md:text-2xl font-bold text-slate-800 flex items-center justify-center md:justify-start gap-2">
                        <span id="stage-icon">ğŸ§ª</span> 
                        <span id="stage-title">å…ƒç´ é…å°å¤§æŒ‘æˆ°</span>
                    </h1>
                    <p id="stage-desc" class="text-xs md:text-sm text-slate-500 hidden md:block">è«‹å°‡å¡ç‰‡æ‹–æ›³åˆ°ä¸‹æ–¹æ”¶é›†ç›’é€²è¡Œé…å°ã€‚</p>
                </div>
            </div>
            <div class="flex gap-2 w-full md:w-auto justify-center">
                <button id="btn-check" onclick="checkAnswers()" class="flex-1 md:flex-none bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold shadow transition flex items-center justify-center gap-2 text-sm md:text-base">
                    <span>âœ…</span> æª¢æŸ¥
                </button>
                <button onclick="resetGame()" class="flex-1 md:flex-none bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold transition text-sm md:text-base">
                    ğŸ”„ é‡ç½®
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»éŠæˆ²å€åŸŸ -->
    <main class="flex-1 flex flex-col overflow-hidden max-w-7xl mx-auto w-full p-2 md:p-4 gap-2 md:gap-4 relative">
        
        <!-- ç¬¬ä¸€éšæ®µä»‹é¢ -->
        <div id="stage-1" class="flex-1 flex flex-col gap-2 md:gap-4 overflow-hidden h-full w-full">
            
            <!-- å¡ç‰‡åº«åˆ†å€ï¼šå·¦å³å…©æ¬„ (é«˜åº¦èª¿æ•´ç‚º 35%) -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 flex h-[35%] shrink-0 transition-all duration-500 overflow-hidden divide-x divide-slate-200" id="source-section">
                
                <!-- å·¦å´ï¼šå…ƒç´ /ç¬¦è™Ÿ æš«å­˜å€ (30% -> Mobile 35%) -->
                <div class="w-[35%] md:w-1/3 flex flex-col bg-slate-50/50">
                    <div id="label-left" class="p-1 md:p-2 border-b text-[10px] md:text-xs font-bold text-slate-500 text-center bg-slate-100 truncate">
                        åç¨± / ç¬¦è™Ÿ
                    </div>
                    <div id="source-left" class="flex-1 overflow-y-auto custom-scroll p-2 flex flex-wrap gap-2 content-start justify-center">
                        <!-- JS ç”Ÿæˆå…§å®¹ -->
                    </div>
                </div>

                <!-- å³å´ï¼šæ€§è³ª æš«å­˜å€ (70% -> Mobile 65%) -->
                <div class="w-[65%] md:w-2/3 flex flex-col bg-white">
                    <div class="p-1 md:p-2 border-b text-[10px] md:text-xs font-bold text-slate-500 text-center bg-white">
                        æ€§è³ªæè¿° (è«‹æ‹–æ›³)
                    </div>
                    <div id="source-right" class="flex-1 overflow-y-auto custom-scroll p-2 flex flex-wrap gap-2 content-start">
                        <!-- JS ç”Ÿæˆå…§å®¹ -->
                    </div>
                </div>

            </section>

            <!-- é…å°æ”¶é›†ç›’å€ -->
            <section class="flex-1 overflow-y-auto custom-scroll" id="target-section">
                <!-- Mobile: 1 col, Tablet: 2 cols, Desktop: 3/4 cols -->
                <div id="target-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4 pb-10">
                    <!-- æ”¶é›†ç›’ç”Ÿæˆå€ -->
                </div>
            </section>
        </div>

        <!-- ç¬¬äºŒéšæ®µä»‹é¢ -->
        <div id="stage-2" class="hidden flex-1 flex-col gap-2 md:gap-4 overflow-hidden w-full h-full">
            <div class="flex-1 min-h-0 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                <!-- åˆ†é¡ç®±ï¼šå°é›» -->
                <div id="bin-conductor" 
                     class="class-bin bg-white border-4 border-dashed border-amber-300 rounded-2xl p-2 md:p-4 relative"
                     data-accept="good">
                    <div class="absolute top-0 left-0 w-full bg-amber-100 py-2 text-center font-bold text-amber-800 z-10 shadow-sm text-sm md:text-base">
                        âš¡ å®¹æ˜“å°é›» (Good)
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll pt-10 md:pt-12 content-area flex flex-row flex-wrap md:flex-col gap-2 content-start">
                        <!-- æ‹–æ›³é€²ä¾†çš„å…ƒç´ å¡Š -->
                    </div>
                </div>

                <!-- åˆ†é¡ç®±ï¼šä¸æ˜“å°é›» -->
                <div id="bin-insulator" 
                     class="class-bin bg-white border-4 border-dashed border-slate-300 rounded-2xl p-2 md:p-4 relative"
                     data-accept="poor">
                    <div class="absolute top-0 left-0 w-full bg-slate-100 py-2 text-center font-bold text-slate-700 z-10 shadow-sm text-sm md:text-base">
                        ğŸš« ä¸æ˜“å°é›» (Poor)
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll pt-10 md:pt-12 content-area flex flex-row flex-wrap md:flex-col gap-2 content-start">
                        <!-- æ‹–æ›³é€²ä¾†çš„å…ƒç´ å¡Š -->
                    </div>
                </div>
            </div>

            <!-- å¾…åˆ†é¡å…ƒç´ å€ -->
            <div id="classification-source" class="h-36 md:h-48 shrink-0 bg-white rounded-xl shadow-inner border p-2 md:p-4 overflow-x-auto flex gap-2 md:gap-4 items-center">
                <!-- é€™è£¡æœƒæ”¾å…¥ç¬¬ä¸€éšæ®µå®Œæˆçš„æ•´çµ„å¡ç‰‡ -->
            </div>
        </div>

    </main>

    <!-- é€šç”¨å½ˆçª— -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-md text-center transform scale-100 animate-pop">
            <div id="modal-icon" class="text-5xl md:text-6xl mb-4">ğŸ‰</div>
            <h2 id="modal-title" class="text-xl md:text-2xl font-bold mb-2">æ¨™é¡Œ</h2>
            <p id="modal-message" class="text-sm md:text-base text-gray-600 mb-6 whitespace-pre-line">å…§å®¹</p>
            <button id="modal-btn" onclick="closeModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 font-bold w-full">
                ç¢ºå®š
            </button>
        </div>
    </div>

    <!-- éš±è—çš„è‡¨æ™‚å®¹å™¨ -->
    <div id="temp-storage" class="hidden"></div>

    <script>
        const elementsData = [
            { id: 1, name: "é‡‘", symbol: "Au", prop: "é»ƒè‰²å›ºé«”ï¼Œå»¶å±•æ€§æ¥µä½³ï¼Œä¸æ°§åŒ–", group: "é‡‘å±¬", conduct: "good" },
            { id: 2, name: "éŠ…", symbol: "Cu", prop: "ç´…æ£•è‰²å›ºé«”ï¼Œè‰¯å°é«”ï¼Œåšé›»ç·š", group: "é‡‘å±¬", conduct: "good" },
            { id: 3, name: "é‹", symbol: "Al", prop: "éŠ€ç°è‰²ï¼Œè³ªè¼•ï¼Œæ˜“æ°§åŒ–å½¢æˆä¿è­·å±¤", group: "é‡‘å±¬", conduct: "good" },
            { id: 4, name: "æ±", symbol: "Hg", prop: "å¸¸æº«å”¯ä¸€æ¶²æ…‹é‡‘å±¬ï¼Œæœ‰æ¯’", group: "é‡‘å±¬", conduct: "good" },
            { id: 5, name: "é‹°", symbol: "Li", prop: "å¯†åº¦æœ€å°é‡‘å±¬ï¼Œé‡æ°´åæ‡‰ç”¢ç”Ÿæ°«æ°£", group: "é¹¼é‡‘å±¬", conduct: "good" },
            { id: 6, name: "éˆ‰", symbol: "Na", prop: "è³ªè»Ÿå¯åˆ‡ï¼Œæ´»æ€§å¤§éœ€å­˜æ–¼ç…¤æ²¹", group: "é¹¼é‡‘å±¬", conduct: "good" },
            { id: 7, name: "é‰€", symbol: "K", prop: "é‡æ°´åŠ‡çƒˆåæ‡‰ç‡ƒç‡’ï¼Œç´«è‰²ç«ç„°", group: "é¹¼é‡‘å±¬", conduct: "good" },
            { id: 8, name: "ç¢³", symbol: "C", prop: "é»‘è‰²å›ºé«”ï¼Œå”¯ä¸€å¯å°é›»éé‡‘å±¬(çŸ³å¢¨)", group: "éé‡‘å±¬", conduct: "good" }, 
            { id: 9, name: "ç¡«", symbol: "S", prop: "é»ƒè‰²å›ºé«”ï¼Œæ˜“ç¢ï¼Œç‡ƒç‡’æœ‰åˆºé¼»å‘³", group: "éé‡‘å±¬", conduct: "poor" },
            { id: 10, name: "çŸ½", symbol: "Si", prop: "åŠå°é«”ææ–™ï¼Œå…·é‡‘å±¬å…‰æ¾¤ä½†æ˜“ç¢", group: "é¡é‡‘å±¬", conduct: "poor" }, 
            { id: 11, name: "æº´", symbol: "Br", prop: "æš—ç´…è‰²æ¶²é«”ï¼Œå…·å¼·çƒˆåˆºé¼»æ¯’æ€§", group: "éé‡‘å±¬", conduct: "poor" },
            { id: 12, name: "æ°§", symbol: "O", prop: "ç„¡è‰²æ°£é«”ï¼ŒåŠ©ç‡ƒï¼Œä¾›ç”Ÿç‰©å‘¼å¸", group: "éé‡‘å±¬", conduct: "poor" }
        ];

        let currentStage = 1;

        // --- åˆå§‹åŒ–èˆ‡éŠæˆ²æ§åˆ¶ ---

        function initGame() {
            currentStage = 1;
            updateUIForStage(1);
            
            document.getElementById('start-screen').classList.remove('hidden');

            document.getElementById('source-left').innerHTML = '';
            document.getElementById('source-right').innerHTML = '';
            document.getElementById('target-grid').innerHTML = '';
            document.getElementById('temp-storage').innerHTML = '';

            // ç”Ÿæˆå¡ç‰‡
            elementsData.forEach(el => {
                const cardName = createCardElement({ id: `name-${el.id}`, elId: el.id, type: 'name', content: el.name, group: el.group });
                const cardSymbol = createCardElement({ id: `sym-${el.id}`, elId: el.id, type: 'symbol', content: el.symbol, group: el.group });
                const cardProp = createCardElement({ id: `prop-${el.id}`, elId: el.id, type: 'prop', content: el.prop, group: el.group });
                
                document.getElementById('temp-storage').appendChild(cardName);
                document.getElementById('temp-storage').appendChild(cardSymbol);
                document.getElementById('temp-storage').appendChild(cardProp);
            });

            // ç”Ÿæˆæ ¼å­
            const targetGrid = document.getElementById('target-grid');
            for (let i = 1; i <= 12; i++) {
                const box = document.createElement('div');
                box.className = 'drop-zone bg-white rounded-xl border-2 border-dashed border-slate-300 p-2 md:p-3 relative transition-all';
                box.dataset.zoneId = i;
                box.innerHTML = `<div class="text-[10px] md:text-xs text-slate-300 font-bold absolute bottom-1 right-2 z-0">çµ„åˆ ${i}</div>`;
                
                box.addEventListener('dragover', handleDragOver);
                box.addEventListener('dragleave', handleDragLeave);
                box.addEventListener('drop', handleDrop);
                targetGrid.appendChild(box);
            }

            const srcLeft = document.getElementById('source-left');
            const srcRight = document.getElementById('source-right');
            srcLeft.addEventListener('dragover', handleDragOver);
            srcLeft.addEventListener('drop', handleDropToSource);
            srcRight.addEventListener('dragover', handleDragOver);
            srcRight.addEventListener('drop', handleDropToSource);
        }

        function startGame(type) {
            document.getElementById('start-screen').classList.add('hidden');
            autoFill(type);
            organizeRemainingCards(type);
        }

        function updateUIForStage(stage) {
            const title = document.getElementById('stage-title');
            const desc = document.getElementById('stage-desc');
            const stage1Div = document.getElementById('stage-1');
            const stage2Div = document.getElementById('stage-2');
            const btnCheck = document.getElementById('btn-check');

            if (stage === 1) {
                // title.innerText ä¿æŒä¸è®Š
                if(desc) desc.innerText = "ç¬¬ä¸€éšæ®µï¼šè«‹å°‡å¡ç‰‡æ‹–æ›³åˆ°ä¸‹æ–¹æ”¶é›†ç›’é€²è¡Œé…å°ã€‚";
                stage1Div.classList.remove('hidden');
                stage2Div.classList.add('hidden');
                btnCheck.innerText = "âœ… æª¢æŸ¥";
                btnCheck.onclick = checkAnswers;
            } else {
                if(desc) desc.innerText = "ç¬¬äºŒéšæ®µï¼šæ‹–æ›³æ•´çµ„å¡ç‰‡ï¼Œå°‡å®ƒå€‘ä¾ã€Œå°é›»æ€§ã€åˆ†é¡ã€‚";
                stage1Div.classList.add('hidden');
                stage2Div.classList.remove('hidden');
                stage2Div.classList.add('flex');
                btnCheck.innerText = "ğŸ† å®Œæˆ";
                btnCheck.onclick = checkClassification;
                
                ['bin-conductor', 'bin-insulator'].forEach(id => {
                    const bin = document.getElementById(id);
                    bin.addEventListener('dragover', handleDragOver);
                    bin.addEventListener('dragleave', handleDragLeave);
                    bin.addEventListener('drop', handleBlockDrop);
                });
            }
        }

        // --- DOM ç”Ÿæˆ (éŸ¿æ‡‰å¼ Class) ---

        function createCardElement(card) {
            const div = document.createElement('div');
            div.id = card.id;
            div.draggable = true;
            div.dataset.elId = card.elId;
            div.dataset.type = card.type;
            
            // éŸ¿æ‡‰å¼åŸºç¤æ¨£å¼
            // w-20 (Mobile) -> md:w-24 -> lg:w-28
            let baseClass = "draggable-card bg-white shadow-sm rounded-md p-1 md:p-2 w-20 md:w-24 lg:w-28 text-center border cursor-grab text-xs md:text-sm relative select-none shrink-0 z-10 min-h-[3rem]";
            let contentHtml = '';
            
            if (card.type === 'name') {
                div.className = `${baseClass} card-name border-blue-200 hover:border-blue-400`;
                contentHtml = `<div class="font-bold text-base md:text-lg text-slate-800">${card.content}</div>`;
            } else if (card.type === 'symbol') {
                div.className = `${baseClass} card-symbol border-green-200 hover:border-green-400`;
                contentHtml = `<div class="font-serif font-bold text-xl md:text-2xl text-green-700">${card.content}</div>`;
            } else {
                // æ€§è³ªå¡
                div.className = `${baseClass} card-prop border-rose-200 hover:border-rose-400 text-left`;
                contentHtml = `<div class="text-[10px] md:text-xs text-slate-600 leading-tight line-clamp-3">${card.content}</div>`;
            }

            div.innerHTML = contentHtml;
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            return div;
        }

        // --- æ¨£å¼æ§åˆ¶è¼”åŠ©å‡½å¼ (éŸ¿æ‡‰å¼ Class æ¢å¾©) ---

        function setCardStyleForZone(card) {
            // ç§»é™¤å›ºå®šå¯¬åº¦ï¼Œè®“ Grid æ§åˆ¶
            card.classList.remove('w-20', 'md:w-24', 'lg:w-28');
            
            if (card.dataset.type === 'symbol') card.classList.add('pos-symbol');
            if (card.dataset.type === 'name') card.classList.add('pos-name');
            if (card.dataset.type === 'prop') card.classList.add('pos-prop');
        }

        function resetCardStyleForSource(card) {
            // æ¢å¾©éŸ¿æ‡‰å¼å›ºå®šå¯¬åº¦
            card.classList.add('w-20', 'md:w-24', 'lg:w-28');
            card.classList.remove('pos-symbol', 'pos-name', 'pos-prop');
        }

        // --- é‚è¼¯ï¼šè‡ªå‹•å¡«å…¥èˆ‡åˆ†é¡ ---

        function autoFill(type) {
            const zones = document.querySelectorAll('.drop-zone');
            
            let zoneIndices = Array.from({length: 12}, (_, i) => i);
            zoneIndices.sort(() => Math.random() - 0.5);
            
            const elementToZoneMap = {};
            elementsData.forEach((el, index) => {
                elementToZoneMap[el.id] = zones[zoneIndices[index]];
            });

            const targetType = type;
            const allCards = Array.from(document.querySelectorAll('#temp-storage .draggable-card'));
            
            allCards.forEach(card => {
                if (card.dataset.type === targetType) {
                    const elId = parseInt(card.dataset.elId);
                    const targetZone = elementToZoneMap[elId];
                    if (targetZone) {
                        targetZone.appendChild(card);
                        setCardStyleForZone(card);
                    }
                }
            });
        }

        function organizeRemainingCards(filledType) {
            const leftContainer = document.getElementById('source-left');
            const rightContainer = document.getElementById('source-right');
            const labelLeft = document.getElementById('label-left');

            const remainingCards = Array.from(document.querySelectorAll('#temp-storage .draggable-card'));
            remainingCards.sort(() => Math.random() - 0.5);

            const leftType = filledType === 'name' ? 'symbol' : 'name';
            labelLeft.innerText = filledType === 'name' ? "å…ƒç´ ç¬¦è™Ÿ" : "å…ƒç´ åç¨±";

            remainingCards.forEach(card => {
                resetCardStyleForSource(card);
                if (card.dataset.type === 'prop') {
                    rightContainer.appendChild(card);
                } else if (card.dataset.type === leftType) {
                    leftContainer.appendChild(card);
                }
            });
        }

        // --- æ‹–æ›³äº‹ä»¶è™•ç† (ç¬¬ä¸€éšæ®µ) ---

        let draggedItem = null;

        function handleDragStart(e) {
            if (currentStage !== 1) return;
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.id);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedItem = null;
            document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this.classList.contains('drop-zone') || this.classList.contains('class-bin')) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (this.classList.contains('drop-zone') || this.classList.contains('class-bin')) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (currentStage !== 1) return;

            const cardId = e.dataTransfer.getData('text/plain');
            const card = document.getElementById(cardId);
            
            if (card && this.classList.contains('drop-zone')) {
                const type = card.dataset.type;
                const existingCard = this.querySelector(`.draggable-card[data-type="${type}"]`);
                
                if (existingCard && existingCard.id !== card.id) {
                    returnCardToSource(existingCard);
                }
                this.appendChild(card);
                setCardStyleForZone(card); 
            }
        }

        function handleDropToSource(e) {
            e.preventDefault();
            if (currentStage !== 1) return;

            const cardId = e.dataTransfer.getData('text/plain');
            const card = document.getElementById(cardId);
            if (card) {
                returnCardToSource(card);
            }
        }

        function returnCardToSource(card) {
            const leftContainer = document.getElementById('source-left');
            const rightContainer = document.getElementById('source-right');
            resetCardStyleForSource(card);

            if (card.dataset.type === 'prop') {
                rightContainer.appendChild(card);
            } else {
                leftContainer.appendChild(card);
            }
        }

        // --- æª¢æŸ¥ç­”æ¡ˆ (ç¬¬ä¸€éšæ®µ) ---

        function checkAnswers() {
            const zones = document.querySelectorAll('.drop-zone');
            let correctCount = 0;
            let errorCount = 0;

            zones.forEach(zone => {
                const cardsInZone = Array.from(zone.querySelectorAll('.draggable-card'));
                if (cardsInZone.length === 0) return;

                const ids = cardsInZone.map(c => c.dataset.elId);
                const types = cardsInZone.map(c => c.dataset.type);
                
                const hasName = types.includes('name');
                const hasSymbol = types.includes('symbol');
                const hasProp = types.includes('prop');
                const isCompleteSet = hasName && hasSymbol && hasProp && cardsInZone.length === 3;
                const allSameId = ids.every(id => id === ids[0]);

                zone.className = 'drop-zone bg-white rounded-xl border-2 border-dashed border-slate-300 p-2 md:p-3 relative transition-all';
                zone.querySelector('.status-icon')?.remove();

                if (isCompleteSet && allSameId) {
                    zone.classList.remove('border-slate-300', 'bg-white');
                    zone.classList.add('border-green-500', 'bg-green-50');
                    zone.innerHTML += '<div class="status-icon absolute bottom-1 right-1 text-green-500 text-lg md:text-xl z-20">âœ…</div>';
                    correctCount++;
                } else if (cardsInZone.length > 0 && (!allSameId)) {
                    zone.classList.remove('border-slate-300', 'bg-white');
                    zone.classList.add('border-red-400', 'bg-red-50');
                    errorCount++;
                } else {
                    zone.classList.remove('border-slate-300', 'bg-white');
                    zone.classList.add('border-yellow-400', 'bg-yellow-50');
                }
            });

            if (correctCount === 12) {
                showModal('ğŸ‰ ç¬¬ä¸€éšæ®µå®Œæˆï¼', 'å¤ªæ£’äº†ï¼æ‰€æœ‰é…å°éƒ½æ­£ç¢ºã€‚\næ¥ä¸‹ä¾†é€²å…¥ç¬¬äºŒéšæ®µï¼šåˆ†é¡æŒ‘æˆ°ï¼', 'success', startStage2);
            } else {
                let msg = `ç›®å‰æœ‰ ${correctCount} çµ„æ­£ç¢ºã€‚`;
                if (errorCount > 0) msg += `\nç™¼ç¾ ${errorCount} çµ„é…å°éŒ¯èª¤ (ç´…è‰²)ã€‚`;
                else msg += `\né‚„æœ‰æ ¼å­æ²’å¡«æ»¿æˆ–ç¼ºæ¼ (é»ƒè‰²)ã€‚`;
                alert(msg);
            }
        }

        // --- ç¬¬äºŒéšæ®µï¼šåˆ†é¡æŒ‘æˆ° ---

        function startStage2() {
            closeModal();
            currentStage = 2;
            updateUIForStage(2);
            prepareClassificationItems();
        }

        function prepareClassificationItems() {
            const zones = document.querySelectorAll('.drop-zone');
            const classSource = document.getElementById('classification-source');
            classSource.innerHTML = '';

            zones.forEach(zone => {
                const cardsInZone = Array.from(zone.querySelectorAll('.draggable-card'));
                if (cardsInZone.length === 0) return;
                
                const elId = cardsInZone[0].dataset.elId;
                const elementInfo = elementsData.find(e => e.id == elId);

                const block = document.createElement('div');
                // éŸ¿æ‡‰å¼ Block å¯¬åº¦
                block.className = 'element-block bg-white border border-slate-300 shadow-md rounded-lg p-2 shrink-0 flex flex-col gap-1 select-none hover:shadow-lg hover:border-indigo-400';
                block.draggable = true;
                block.id = `block-${elId}`;
                block.dataset.elId = elId;
                block.dataset.conduct = elementInfo.conduct;

                cardsInZone.forEach(c => {
                    const clone = c.cloneNode(true);
                    clone.classList.remove('pos-symbol', 'pos-name', 'pos-prop');
                    // Block å…§éƒ¨ä¸ä½¿ç”¨ Gridï¼Œæ‰€ä»¥é‡ç½®å¯¬åº¦ç‚º 100%
                    clone.classList.remove('w-20', 'md:w-24', 'lg:w-28'); 
                    clone.classList.add('w-full', 'text-xs'); 
                    clone.style.height = 'auto'; 
                    block.appendChild(clone);
                });

                block.addEventListener('dragstart', handleBlockDragStart);
                block.addEventListener('dragend', handleDragEnd);

                classSource.appendChild(block);
            });
        }

        function handleBlockDragStart(e) {
            if (currentStage !== 2) return;
            draggedItem = this;
            this.classList.add('opacity-50');
            e.dataTransfer.setData('text/plain', this.id);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleBlockDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            const blockId = e.dataTransfer.getData('text/plain');
            const block = document.getElementById(blockId);
            
            if (block && block.classList.contains('element-block')) {
                const contentArea = this.querySelector('.content-area');
                if(contentArea) {
                    contentArea.appendChild(block);
                    // åœ¨ç±ƒå­è£¡å¯¬åº¦ 100%
                    block.classList.add('w-full');
                    block.classList.remove('max-w-[12rem]', 'lg:max-w-[14rem]'); // ç§»é™¤æœ€å¤§å¯¬åº¦é™åˆ¶ï¼Œè®“å®ƒè‡ªé©æ‡‰ç±ƒå­
                }
            }
        }

        function checkClassification() {
            const bins = ['bin-conductor', 'bin-insulator'];
            let allCorrect = true;
            let totalBlocks = 0;

            bins.forEach(binId => {
                const bin = document.getElementById(binId);
                const requiredType = bin.dataset.accept;
                const blocks = bin.querySelectorAll('.element-block');
                
                blocks.forEach(block => {
                    totalBlocks++;
                    if (block.dataset.conduct !== requiredType) {
                        allCorrect = false;
                        block.classList.add('border-4', 'border-red-500');
                    } else {
                        block.classList.remove('border-red-500', 'border-slate-300');
                        block.classList.add('border-green-500');
                    }
                });
            });

            if (totalBlocks < 12) {
                alert("é‚„æœ‰å…ƒç´ æ²’åˆ†é¡å–”ï¼è«‹å°‡ä¸‹æ–¹æ‰€æœ‰å…ƒç´ æ‹–å…¥ç±ƒå­ã€‚");
                return;
            }

            if (allCorrect) {
                showModal('ğŸ† æŒ‘æˆ°æˆåŠŸï¼', 'æ­å–œä½ ï¼ä¸åƒ…å®Œæˆäº†é…å°ï¼Œé‚„ç²¾é€šäº†å…ƒç´ çš„å°é›»æ€§è³ªåˆ†é¡ï¼', 'success', resetGame);
            } else {
                showModal('âš ï¸ é‚„æœ‰éŒ¯èª¤', 'æœ‰äº›å…ƒç´ æ”¾éŒ¯ç±ƒå­äº† (ç´…è‰²é‚Šæ¡†)ï¼Œè«‹å†æ€è€ƒä¸€ä¸‹å®ƒå€‘çš„æ€§è³ªã€‚', 'error', closeModal);
            }
        }

        // --- é€šç”¨å·¥å…· ---

        function resetGame() {
            if(confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿ')) {
                closeModal();
                initGame();
            }
        }

        function showModal(title, message, type, callback) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            
            const btn = document.getElementById('modal-btn');
            btn.onclick = callback;
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        window.onload = initGame;

    </script>
</body>
</html>
