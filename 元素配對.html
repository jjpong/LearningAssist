<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ƒç´ ç‰¹æ€§é…å° - æ•¸ä½äº’å‹•ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            user-select: none;
            overscroll-behavior: none;
        }
        .draggable-card {
            cursor: grab;
            transition: all 0.2s;
            touch-action: none;
        }
        .draggable-card:active {
            cursor: grabbing;
            transform: scale(1.05);
            z-index: 50;
        }
        .draggable-card.dragging {
            opacity: 0.5;
        }
        
        .card-name { border-left: 4px solid #2563eb; }
        .card-symbol { border-left: 4px solid #059669; }
        .card-prop { border-left: 4px solid #e11d48; }

        /* --- Drop Zone çš„ Grid ä½ˆå±€ --- */
        .drop-zone {
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s;
            min-height: 160px;
            display: grid;
            grid-template-columns: 7rem 1fr; 
            grid-template-rows: 1fr 1fr;
            grid-template-areas:
                "symbol prop"
                "name prop";
            gap: 0.5rem;
        }
        .drop-zone.drag-over {
            background-color: #e0f2fe;
            border-style: dashed;
            transform: scale(1.02);
        }

        /* --- å¡ç‰‡è‡ªå‹•å®šä½ --- */
        .pos-symbol { grid-area: symbol; }
        .pos-name { grid-area: name; }
        .pos-prop { grid-area: prop; }

        .drop-zone .draggable-card {
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drop-zone .draggable-card[data-type="prop"] {
            align-items: flex-start;
            text-align: left;
            padding: 0.5rem;
            overflow-y: auto; 
        }

        /* ç¬¬äºŒéšæ®µï¼šæ•´åˆå¾Œçš„å…ƒç´ å¡Šæ¨£å¼ */
        .element-block {
            cursor: grab;
            transition: transform 0.2s;
            margin-bottom: 0.5rem;
        }
        .element-block:active {
            cursor: grabbing;
            transform: scale(1.02) rotate(2deg);
        }
        .element-block .draggable-card {
            cursor: inherit;
            pointer-events: none;
            width: 100%; 
            height: auto;
        }
        
        /* åˆ†é¡ç±ƒæ¨£å¼ */
        .class-bin {
            transition: all 0.3s;
            /* é—œéµä¿®æ­£ï¼šç¢ºä¿ç±ƒå­å…§éƒ¨å¯ä»¥æ²å‹•ï¼Œè€Œä¸æ˜¯æ’é–‹å®¹å™¨ */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .class-bin.drag-over {
            background-color: #f0fdf4;
            border-color: #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .custom-scroll::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨æ§åˆ¶åˆ— -->
    <header class="bg-white shadow-md p-4 z-10 shrink-0">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <span id="stage-icon">ğŸ§ª</span> 
                    <span id="stage-title">å…ƒç´ é…å°å¤§æŒ‘æˆ°</span>
                </h1>
                <p id="stage-desc" class="text-sm text-slate-500">ç¬¬ä¸€éšæ®µï¼šè«‹å°‡å¡ç‰‡æ‹–æ›³åˆ°ä¸‹æ–¹æ”¶é›†ç›’é€²è¡Œé…å°ã€‚</p>
            </div>
            <div class="flex gap-3">
                <div id="setup-buttons" class="flex gap-2">
                    <button id="btn-fill-name" onclick="autoFill('name')" class="bg-sky-500 hover:bg-sky-600 text-white px-3 py-2 rounded-lg font-bold shadow transition flex items-center gap-1 text-sm">
                        <span>ğŸ“</span> éš¨æ©Ÿå¡«å…¥åç¨±
                    </button>
                    <button id="btn-fill-symbol" onclick="autoFill('symbol')" class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-2 rounded-lg font-bold shadow transition flex items-center gap-1 text-sm">
                        <span>ğŸ” </span> éš¨æ©Ÿå¡«å…¥ç¬¦è™Ÿ
                    </button>
                </div>

                <div class="w-px bg-gray-300 mx-1"></div>

                <button id="btn-check" onclick="checkAnswers()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                    <span>âœ…</span> æª¢æŸ¥ç­”æ¡ˆ
                </button>
                <button onclick="resetGame()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold transition">
                    ğŸ”„ é‡ç½®
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»éŠæˆ²å€åŸŸ -->
    <main class="flex-1 flex flex-col overflow-hidden max-w-7xl mx-auto w-full p-4 gap-4 relative">
        
        <!-- ç¬¬ä¸€éšæ®µä»‹é¢ -->
        <div id="stage-1" class="flex-1 flex flex-col gap-4 overflow-hidden h-full w-full">
            <!-- å¾…é¸å¡ç‰‡å€ -->
            <section class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-1/3 shrink-0 transition-all duration-500" id="source-section">
                <div class="p-2 bg-slate-50 border-b border-slate-200 font-bold text-slate-600 flex justify-between items-center px-4">
                    <span>ğŸ—‚ï¸ å¾…é¸å¡ç‰‡å †</span>
                    <span class="text-xs font-normal bg-blue-100 text-blue-800 px-2 py-1 rounded">æç¤ºï¼šè—=åç¨± / ç¶ =ç¬¦è™Ÿ / ç´…=æ€§è³ª</span>
                </div>
                <div id="source-container" class="flex-1 overflow-x-auto overflow-y-hidden custom-scroll p-4 flex flex-wrap gap-3 content-start items-start">
                    <!-- å¡ç‰‡ç”Ÿæˆå€ -->
                </div>
            </section>

            <!-- é…å°æ”¶é›†ç›’å€ -->
            <section class="flex-1 overflow-y-auto custom-scroll" id="target-section">
                <div id="target-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-10">
                    <!-- æ”¶é›†ç›’ç”Ÿæˆå€ -->
                </div>
            </section>
        </div>

        <!-- ç¬¬äºŒéšæ®µä»‹é¢ -->
        <!-- é—œéµä¿®æ­£ï¼šç¢ºä¿é€™è£¡ä½¿ç”¨ flex-1 ä¸” min-h-0ï¼Œé˜²æ­¢å­å…ƒç´ æ’é–‹çˆ¶å®¹å™¨å°è‡´æº¢å‡º -->
        <div id="stage-2" class="hidden flex-1 flex-col gap-4 overflow-hidden w-full h-full">
            <!-- åˆ†é¡ç±ƒå€åŸŸï¼šä½¿ç”¨ flex-1 ä½”æ»¿å‰©é¤˜ç©ºé–“ï¼Œmin-h-0 å…è¨±å…§éƒ¨æ²è»¸é‹ä½œ -->
            <div class="flex-1 min-h-0 grid grid-cols-2 gap-8">
                <!-- åˆ†é¡ç®±ï¼šå°é›» -->
                <div id="bin-conductor" 
                     class="class-bin bg-white border-4 border-dashed border-amber-300 rounded-2xl p-4 relative"
                     data-accept="good">
                    <div class="absolute top-0 left-0 w-full bg-amber-100 py-2 text-center font-bold text-amber-800 z-10 shadow-sm">
                        âš¡ å®¹æ˜“å°é›» (Good Conductor)
                    </div>
                    <!-- å…§å®¹å€åŸŸï¼šflex-1 å’Œ overflow-y-auto ç¢ºä¿åªæœ‰é€™è£¡æ²å‹• -->
                    <div class="flex-1 overflow-y-auto custom-scroll pt-12 content-area flex flex-col gap-2">
                        <!-- æ‹–æ›³é€²ä¾†çš„å…ƒç´ å¡Š -->
                    </div>
                </div>

                <!-- åˆ†é¡ç®±ï¼šä¸æ˜“å°é›» -->
                <div id="bin-insulator" 
                     class="class-bin bg-white border-4 border-dashed border-slate-300 rounded-2xl p-4 relative"
                     data-accept="poor">
                    <div class="absolute top-0 left-0 w-full bg-slate-100 py-2 text-center font-bold text-slate-700 z-10 shadow-sm">
                        ğŸš« ä¸æ˜“å°é›» (Poor Conductor)
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll pt-12 content-area flex flex-col gap-2">
                        <!-- æ‹–æ›³é€²ä¾†çš„å…ƒç´ å¡Š -->
                    </div>
                </div>
            </div>

            <!-- å¾…åˆ†é¡å…ƒç´ å€ï¼šå›ºå®šé«˜åº¦ (shrink-0) ç¢ºä¿ä¸è¢«æ“ å£“ -->
            <div id="classification-source" class="h-48 shrink-0 bg-white rounded-xl shadow-inner border p-4 overflow-x-auto flex gap-4 items-center">
                <!-- é€™è£¡æœƒæ”¾å…¥ç¬¬ä¸€éšæ®µå®Œæˆçš„æ•´çµ„å¡ç‰‡ -->
            </div>
        </div>

    </main>

    <!-- é€šç”¨å½ˆçª— -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md text-center transform scale-100 animate-pop">
            <div id="modal-icon" class="text-6xl mb-4">ğŸ‰</div>
            <h2 id="modal-title" class="text-2xl font-bold mb-2">æ¨™é¡Œ</h2>
            <p id="modal-message" class="text-gray-600 mb-6">å…§å®¹</p>
            <button id="modal-btn" onclick="closeModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 font-bold w-full">
                ç¢ºå®š
            </button>
        </div>
    </div>

    <script>
        const elementsData = [
            { id: 1, name: "é‡‘", symbol: "Au", prop: "é»ƒè‰²å›ºé«”ï¼Œå»¶å±•æ€§æ¥µä½³ï¼Œä¸æ°§åŒ–", group: "é‡‘å±¬", conduct: "good" },
            { id: 2, name: "éŠ…", symbol: "Cu", prop: "ç´…æ£•è‰²å›ºé«”ï¼Œè‰¯å°é«”ï¼Œåšé›»ç·š", group: "é‡‘å±¬", conduct: "good" },
            { id: 3, name: "é‹", symbol: "Al", prop: "éŠ€ç°è‰²ï¼Œè³ªè¼•ï¼Œæ˜“æ°§åŒ–å½¢æˆä¿è­·å±¤", group: "é‡‘å±¬", conduct: "good" },
            { id: 4, name: "æ±", symbol: "Hg", prop: "å¸¸æº«å”¯ä¸€æ¶²æ…‹é‡‘å±¬ï¼Œæœ‰æ¯’", group: "é‡‘å±¬", conduct: "good" },
            { id: 5, name: "é‹°", symbol: "Li", prop: "å¯†åº¦æœ€å°é‡‘å±¬ï¼Œé‡æ°´åæ‡‰ç”¢ç”Ÿæ°«æ°£", group: "é¹¼é‡‘å±¬", conduct: "good" },
            { id: 6, name: "éˆ‰", symbol: "Na", prop: "è³ªè»Ÿå¯åˆ‡ï¼Œæ´»æ€§å¤§éœ€å­˜æ–¼ç…¤æ²¹", group: "é¹¼é‡‘å±¬", conduct: "good" },
            { id: 7, name: "é‰€", symbol: "K", prop: "é‡æ°´åŠ‡çƒˆåæ‡‰ç‡ƒç‡’ï¼Œç´«è‰²ç«ç„°", group: "é¹¼é‡‘å±¬", conduct: "good" },
            { id: 8, name: "ç¢³", symbol: "C", prop: "é»‘è‰²å›ºé«”ï¼Œå”¯ä¸€å¯å°é›»éé‡‘å±¬(çŸ³å¢¨)", group: "éé‡‘å±¬", conduct: "good" }, 
            { id: 9, name: "ç¡«", symbol: "S", prop: "é»ƒè‰²å›ºé«”ï¼Œæ˜“ç¢ï¼Œç‡ƒç‡’æœ‰åˆºé¼»å‘³", group: "éé‡‘å±¬", conduct: "poor" },
            { id: 10, name: "çŸ½", symbol: "Si", prop: "åŠå°é«”ææ–™ï¼Œå…·é‡‘å±¬å…‰æ¾¤ä½†æ˜“ç¢", group: "é¡é‡‘å±¬", conduct: "poor" }, 
            { id: 11, name: "æº´", symbol: "Br", prop: "æš—ç´…è‰²æ¶²é«”ï¼Œå…·å¼·çƒˆåˆºé¼»æ¯’æ€§", group: "éé‡‘å±¬", conduct: "poor" },
            { id: 12, name: "æ°§", symbol: "O", prop: "ç„¡è‰²æ°£é«”ï¼ŒåŠ©ç‡ƒï¼Œä¾›ç”Ÿç‰©å‘¼å¸", group: "éé‡‘å±¬", conduct: "poor" }
        ];

        let cards = [];
        let draggedItem = null;
        let currentStage = 1;
        let isAutoFilled = false;

        // --- åˆå§‹åŒ–èˆ‡éŠæˆ²æ§åˆ¶ ---

        function initGame() {
            currentStage = 1;
            isAutoFilled = false;
            updateUIForStage(1);
            
            document.getElementById('setup-buttons').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('btn-fill-name').disabled = false;
            document.getElementById('btn-fill-symbol').disabled = false;

            const sourceContainer = document.getElementById('source-container');
            const targetGrid = document.getElementById('target-grid');
            
            sourceContainer.innerHTML = '';
            targetGrid.innerHTML = '';
            cards = [];

            elementsData.forEach(el => {
                cards.push({ id: `name-${el.id}`, elId: el.id, type: 'name', content: el.name, group: el.group });
                cards.push({ id: `sym-${el.id}`, elId: el.id, type: 'symbol', content: el.symbol, group: el.group });
                cards.push({ id: `prop-${el.id}`, elId: el.id, type: 'prop', content: el.prop, group: el.group });
            });

            cards.sort(() => Math.random() - 0.5);

            cards.forEach(card => {
                sourceContainer.appendChild(createCardElement(card));
            });

            for (let i = 1; i <= 12; i++) {
                const box = document.createElement('div');
                box.className = 'drop-zone bg-white rounded-xl border-2 border-dashed border-slate-300 p-3 relative transition-all';
                box.dataset.zoneId = i;
                box.innerHTML = `<div class="text-xs text-slate-300 font-bold absolute bottom-1 right-2 z-0">çµ„åˆ ${i}</div>`;
                
                box.addEventListener('dragover', handleDragOver);
                box.addEventListener('dragleave', handleDragLeave);
                box.addEventListener('drop', handleDrop);
                targetGrid.appendChild(box);
            }

            sourceContainer.addEventListener('dragover', handleDragOver);
            sourceContainer.addEventListener('drop', handleDropToSource);
        }

        function updateUIForStage(stage) {
            const title = document.getElementById('stage-title');
            const desc = document.getElementById('stage-desc');
            const stage1Div = document.getElementById('stage-1');
            const stage2Div = document.getElementById('stage-2');
            const setupButtons = document.getElementById('setup-buttons');
            const btnCheck = document.getElementById('btn-check');

            if (stage === 1) {
                title.innerText = "å…ƒç´ é…å°å¤§æŒ‘æˆ°";
                desc.innerText = "ç¬¬ä¸€éšæ®µï¼šè«‹å°‡å¡ç‰‡æ‹–æ›³åˆ°ä¸‹æ–¹æ”¶é›†ç›’é€²è¡Œé…å°ã€‚";
                stage1Div.classList.remove('hidden');
                stage2Div.classList.add('hidden');
                setupButtons.classList.remove('hidden');
                btnCheck.innerText = "âœ… æª¢æŸ¥ç­”æ¡ˆ";
                btnCheck.onclick = checkAnswers;
            } else {
                title.innerText = "æ€§è³ªåˆ†é¡æŒ‘æˆ°";
                desc.innerText = "ç¬¬äºŒéšæ®µï¼šæ‹–æ›³æ•´çµ„å¡ç‰‡ï¼Œå°‡å®ƒå€‘ä¾ã€Œå°é›»æ€§ã€åˆ†é¡ã€‚";
                stage1Div.classList.add('hidden');
                stage2Div.classList.remove('hidden');
                stage2Div.classList.add('flex');
                setupButtons.classList.add('hidden');
                btnCheck.innerText = "ğŸ† å®Œæˆåˆ†é¡";
                btnCheck.onclick = checkClassification;
                
                ['bin-conductor', 'bin-insulator'].forEach(id => {
                    const bin = document.getElementById(id);
                    bin.addEventListener('dragover', handleDragOver);
                    bin.addEventListener('dragleave', handleDragLeave);
                    bin.addEventListener('drop', handleBlockDrop);
                });
            }
        }

        // --- DOM ç”Ÿæˆ ---

        function createCardElement(card) {
            const div = document.createElement('div');
            div.id = card.id;
            div.draggable = true;
            div.dataset.elId = card.elId;
            div.dataset.type = card.type;
            
            let baseClass = "draggable-card bg-white shadow-sm rounded-md p-2 w-28 text-center border cursor-grab text-sm relative select-none shrink-0 z-10";
            let contentHtml = '';
            
            if (card.type === 'name') {
                div.className = `${baseClass} card-name border-blue-200 hover:border-blue-400`;
                contentHtml = `<div class="font-bold text-lg text-slate-800">${card.content}</div>`;
            } else if (card.type === 'symbol') {
                div.className = `${baseClass} card-symbol border-green-200 hover:border-green-400`;
                contentHtml = `<div class="font-serif font-bold text-2xl text-green-700">${card.content}</div>`;
            } else {
                div.className = `${baseClass} card-prop border-rose-200 hover:border-rose-400 text-left`;
                contentHtml = `<div class="text-xs text-slate-600 leading-tight">${card.content}</div>`;
            }

            div.innerHTML = contentHtml;
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            return div;
        }

        // --- æ¨£å¼æ§åˆ¶è¼”åŠ©å‡½å¼ ---

        function setCardStyleForZone(card) {
            card.classList.remove('w-28');
            if (card.dataset.type === 'symbol') card.classList.add('pos-symbol');
            if (card.dataset.type === 'name') card.classList.add('pos-name');
            if (card.dataset.type === 'prop') card.classList.add('pos-prop');
        }

        function resetCardStyleForSource(card) {
            card.classList.add('w-28');
            card.classList.remove('pos-symbol', 'pos-name', 'pos-prop');
        }

        // --- åŠŸèƒ½ 1ï¼šéš¨æ©Ÿè‡ªå‹•å¡«å…¥ ---
        
        function autoFill(type) {
            const typeName = type === 'symbol' ? 'ç¬¦è™Ÿ' : 'åç¨±';
            const confirmMsg = `ç¢ºå®šè¦è‡ªå‹•å¡«å…¥æ‰€æœ‰ã€Œ${typeName}ã€å—ï¼Ÿ\né€™å°‡æœƒé‡ç½®ç›®å‰çš„æ’åˆ—ï¼Œä¸”åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚`;
            
            if(confirm(confirmMsg)) {
                isAutoFilled = true;
                const setupButtons = document.getElementById('setup-buttons');
                setupButtons.classList.add('opacity-50', 'pointer-events-none');
                
                const zones = document.querySelectorAll('.drop-zone');
                const sourceContainer = document.getElementById('source-container');
                
                const allCards = document.querySelectorAll('.draggable-card');
                allCards.forEach(c => {
                    sourceContainer.appendChild(c);
                    resetCardStyleForSource(c);
                });
                
                let zoneIndices = Array.from({length: 12}, (_, i) => i);
                zoneIndices.sort(() => Math.random() - 0.5);
                
                const elementToZoneMap = {};
                elementsData.forEach((el, index) => {
                    elementToZoneMap[el.id] = zones[zoneIndices[index]];
                });

                const targetClass = type === 'symbol' ? '.card-symbol' : '.card-name';
                const targetCards = Array.from(document.querySelectorAll(targetClass));
                
                targetCards.forEach(card => {
                    const elId = parseInt(card.dataset.elId);
                    const targetZone = elementToZoneMap[elId];
                    if (targetZone) {
                        targetZone.appendChild(card);
                        setCardStyleForZone(card);
                    }
                });
            }
        }

        // --- æ‹–æ›³äº‹ä»¶è™•ç† (ç¬¬ä¸€éšæ®µ) ---

        function handleDragStart(e) {
            if (currentStage !== 1) return;
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.id);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedItem = null;
            document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this.classList.contains('drop-zone') || this.classList.contains('class-bin')) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (this.classList.contains('drop-zone') || this.classList.contains('class-bin')) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (currentStage !== 1) return;

            const cardId = e.dataTransfer.getData('text/plain');
            const card = document.getElementById(cardId);
            
            if (card && this.classList.contains('drop-zone')) {
                // --- é—œéµä¿®æ”¹ï¼šæª¢æŸ¥æ ¼å­å…§æ˜¯å¦å·²æœ‰åŒé¡å‹çš„å¡ç‰‡ ---
                const type = card.dataset.type;
                // æŸ¥æ‰¾è©²æ ¼å­å…§ç›®å‰å·²å­˜åœ¨çš„åŒé¡å‹å¡ç‰‡
                const existingCard = this.querySelector(`.draggable-card[data-type="${type}"]`);
                
                // å¦‚æœæœ‰æ‰¾åˆ°ï¼Œä¸”ä¸æ˜¯è‡ªå·±æœ¬èº«ï¼ˆé¿å…é‡è¤‡è§¸ç™¼ï¼‰
                if (existingCard && existingCard.id !== card.id) {
                    // æŠŠèˆŠçš„å¡ç‰‡è¸¢å›ä¾†æºå€ (source-container)
                    const sourceContainer = document.getElementById('source-container');
                    sourceContainer.appendChild(existingCard);
                    resetCardStyleForSource(existingCard); // æ¢å¾©å…¶æ¨£å¼
                }

                // æ”¾å…¥æ–°å¡ç‰‡
                this.appendChild(card);
                setCardStyleForZone(card); 
            }
        }

        function handleDropToSource(e) {
            e.preventDefault();
            if (currentStage !== 1) return;

            const cardId = e.dataTransfer.getData('text/plain');
            const card = document.getElementById(cardId);
            if (card) {
                this.appendChild(card);
                resetCardStyleForSource(card);
            }
        }

        // --- æª¢æŸ¥ç­”æ¡ˆ (ç¬¬ä¸€éšæ®µ) ---

        function checkAnswers() {
            const zones = document.querySelectorAll('.drop-zone');
            let correctCount = 0;
            let errorCount = 0;

            zones.forEach(zone => {
                const cardsInZone = Array.from(zone.querySelectorAll('.draggable-card'));
                if (cardsInZone.length === 0) return;

                const ids = cardsInZone.map(c => c.dataset.elId);
                const types = cardsInZone.map(c => c.dataset.type);
                
                const hasName = types.includes('name');
                const hasSymbol = types.includes('symbol');
                const hasProp = types.includes('prop');
                const isCompleteSet = hasName && hasSymbol && hasProp && cardsInZone.length === 3;
                const allSameId = ids.every(id => id === ids[0]);

                zone.className = 'drop-zone bg-white rounded-xl border-2 border-dashed border-slate-300 p-3 relative transition-all';
                zone.querySelector('.status-icon')?.remove();

                if (isCompleteSet && allSameId) {
                    zone.classList.remove('border-slate-300', 'bg-white');
                    zone.classList.add('border-green-500', 'bg-green-50');
                    zone.innerHTML += '<div class="status-icon absolute bottom-2 right-2 text-green-500 text-xl z-20">âœ…</div>';
                    correctCount++;
                } else if (cardsInZone.length > 0 && (!allSameId)) {
                    zone.classList.remove('border-slate-300', 'bg-white');
                    zone.classList.add('border-red-400', 'bg-red-50');
                    errorCount++;
                } else {
                    zone.classList.remove('border-slate-300', 'bg-white');
                    zone.classList.add('border-yellow-400', 'bg-yellow-50');
                }
            });

            if (correctCount === 12) {
                showModal('ğŸ‰ ç¬¬ä¸€éšæ®µå®Œæˆï¼', 'å¤ªæ£’äº†ï¼æ‰€æœ‰é…å°éƒ½æ­£ç¢ºã€‚\næ¥ä¸‹ä¾†é€²å…¥ç¬¬äºŒéšæ®µï¼šåˆ†é¡æŒ‘æˆ°ï¼\nè«‹å°‡æ•´çµ„å¡ç‰‡æ‹–æ›³åˆ°æ­£ç¢ºçš„å°é›»æ€§åˆ†é¡ä¸­ã€‚', 'success', startStage2);
            } else {
                let msg = `ç›®å‰æœ‰ ${correctCount} çµ„æ­£ç¢ºã€‚`;
                if (errorCount > 0) msg += `\nç™¼ç¾ ${errorCount} çµ„é…å°éŒ¯èª¤ (ç´…è‰²)ã€‚`;
                else msg += `\né‚„æœ‰æ ¼å­æ²’å¡«æ»¿æˆ–ç¼ºæ¼ (é»ƒè‰²)ã€‚`;
                alert(msg);
            }
        }

        // --- ç¬¬äºŒéšæ®µï¼šåˆ†é¡æŒ‘æˆ° ---

        function startStage2() {
            closeModal();
            currentStage = 2;
            updateUIForStage(2);
            prepareClassificationItems();
        }

        function prepareClassificationItems() {
            const zones = document.querySelectorAll('.drop-zone');
            const classSource = document.getElementById('classification-source');
            classSource.innerHTML = '';

            zones.forEach(zone => {
                const cardsInZone = Array.from(zone.querySelectorAll('.draggable-card'));
                if (cardsInZone.length === 0) return;
                
                const elId = cardsInZone[0].dataset.elId;
                const elementInfo = elementsData.find(e => e.id == elId);

                const block = document.createElement('div');
                block.className = 'element-block bg-white border border-slate-300 shadow-md rounded-lg p-2 w-48 shrink-0 flex flex-col gap-1 select-none hover:shadow-lg hover:border-indigo-400';
                block.draggable = true;
                block.id = `block-${elId}`;
                block.dataset.elId = elId;
                block.dataset.conduct = elementInfo.conduct;

                cardsInZone.forEach(c => {
                    const clone = c.cloneNode(true);
                    clone.classList.remove('pos-symbol', 'pos-name', 'pos-prop');
                    clone.classList.remove('w-28'); 
                    clone.classList.add('w-full', 'text-xs'); 
                    clone.style.height = 'auto'; 
                    block.appendChild(clone);
                });

                block.addEventListener('dragstart', handleBlockDragStart);
                block.addEventListener('dragend', handleDragEnd);

                classSource.appendChild(block);
            });
        }

        function handleBlockDragStart(e) {
            if (currentStage !== 2) return;
            draggedItem = this;
            this.classList.add('opacity-50');
            e.dataTransfer.setData('text/plain', this.id);
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleBlockDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            const blockId = e.dataTransfer.getData('text/plain');
            const block = document.getElementById(blockId);
            
            if (block && block.classList.contains('element-block')) {
                const contentArea = this.querySelector('.content-area');
                if(contentArea) {
                    contentArea.appendChild(block);
                    block.classList.remove('w-48');
                    block.classList.add('w-full');
                }
            }
        }

        function checkClassification() {
            const bins = ['bin-conductor', 'bin-insulator'];
            let allCorrect = true;
            let totalBlocks = 0;

            bins.forEach(binId => {
                const bin = document.getElementById(binId);
                const requiredType = bin.dataset.accept;
                const blocks = bin.querySelectorAll('.element-block');
                
                blocks.forEach(block => {
                    totalBlocks++;
                    if (block.dataset.conduct !== requiredType) {
                        allCorrect = false;
                        block.classList.add('border-4', 'border-red-500');
                    } else {
                        block.classList.remove('border-red-500', 'border-slate-300');
                        block.classList.add('border-green-500');
                    }
                });
            });

            if (totalBlocks < 12) {
                alert("é‚„æœ‰å…ƒç´ æ²’åˆ†é¡å–”ï¼è«‹å°‡ä¸‹æ–¹æ‰€æœ‰å…ƒç´ æ‹–å…¥ç±ƒå­ã€‚");
                return;
            }

            if (allCorrect) {
                showModal('ğŸ† æŒ‘æˆ°æˆåŠŸï¼', 'æ­å–œä½ ï¼ä¸åƒ…å®Œæˆäº†é…å°ï¼Œé‚„ç²¾é€šäº†å…ƒç´ çš„å°é›»æ€§è³ªåˆ†é¡ï¼', 'success', resetGame);
            } else {
                showModal('âš ï¸ é‚„æœ‰éŒ¯èª¤', 'æœ‰äº›å…ƒç´ æ”¾éŒ¯ç±ƒå­äº† (ç´…è‰²é‚Šæ¡†)ï¼Œè«‹å†æ€è€ƒä¸€ä¸‹å®ƒå€‘çš„æ€§è³ªã€‚', 'error', closeModal);
            }
        }

        // --- é€šç”¨å·¥å…· ---

        function resetGame() {
            if(confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿ')) {
                closeModal();
                initGame();
            }
        }

        function showModal(title, message, type, callback) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            
            const btn = document.getElementById('modal-btn');
            btn.onclick = callback;
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        window.onload = initGame;

    </script>
</body>
</html>